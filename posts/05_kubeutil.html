<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>封装我最常用的 3 个 kubectl 命令</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/352a7f6477311b3a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/352a7f6477311b3a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-6cbe6e332df95288.js" defer=""></script><script src="/_next/static/chunks/main-26f9f36b33181737.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d6bf7b3192a8752.js" defer=""></script><script src="/_next/static/chunks/73-96e6cbd54826b874.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4b57e02c440700a5.js" defer=""></script><script src="/_next/static/NuG4xb_OUEJ1r6hPWds1R/_buildManifest.js" defer=""></script><script src="/_next/static/NuG4xb_OUEJ1r6hPWds1R/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-4xl px-4 mt-12 mb-24 mx-auto"><main><article><h1 class="text-3xl font-medium my-4 border-b-0">封装我最常用的 3 个 kubectl 命令</h1><div class="text-gray-500 mb-8 pb-2 border-b-2 border-solid border-slate-300"><time dateTime="2022-08-17">August 17, 2022</time></div><div><p>这篇文章介绍了我最常用的 3 个 <code>kubectl</code> 命令，以及如何使用 bash 脚本将它们封装成我喜欢的样子。</p>
<p>最近开始用 <code>kubectl</code>，发现有几个命令高频出现，下面来看一下这几个命令。</p>
<ol>
<li>查询 pod 的运行状态</li>
</ol>
<pre><code class="hljs language-sh">kubectl get pods -n NAMESPACE | grep NAME_PATTERN
</code></pre>
<ol start="2">
<li>查询某个 pod 的日志</li>
</ol>
<pre><code class="hljs language-sh">kubectl get pods -n NAMESPACE | grep xxx | awk <span class="hljs-string">'{print $1}'</span> | xargs kubectl logs -n NAMESPACE
</code></pre>
<ol start="3">
<li>登录到某个 pod</li>
</ol>
<pre><code class="hljs language-sh">kubectl get pods -n NAMESPACE | grep xxx | awk <span class="hljs-string">'{print $1}'</span> | xargs -I {} kubectl <span class="hljs-built_in">exec</span> -n NAMESPACE -it {} /bin/bash
</code></pre>
<p>每次都要敲这么多字符才能达成我们想要的结果，基本都是重复的东西，很容易想到我们可以把这几个命令写成 bash 脚本，假设这个脚本叫 <code>kubeutil</code>，
预期的接口是</p>
<pre><code class="hljs language-sh"><span class="hljs-comment"># 获取名字中包含 “xxx” 的 pod 的运行状态</span>
kubeutil get xxx

<span class="hljs-comment"># 获取名字中包含 “xxx” 的 pod 的日志</span>
kubeutil <span class="hljs-built_in">log</span> xxx

<span class="hljs-comment"># 登录到名字中包含 “xxx” 的 pod</span>
kubeutil <span class="hljs-built_in">exec</span> xxx
</code></pre>
<p><code>kubeutil log</code> 和 <code>kubeutil exec</code> 这两个脚本在逻辑上有个明显的漏洞，我们用 <code>grep xxx</code> 去匹配 pod 名字中包含 "xxx" 的 pod，如果有不止一个 pod 满足匹配要求呢？应该获取哪个 pod 的日志呢？登录进哪个 pod 呢？</p>
<p>我们需要使 <code>grep xxx</code> 只匹配唯一一个 pod，那就得下更多的功夫在 <code>xxx</code> 上，得找到合适的匹配规则。实际上这让我很头疼，我总是需要先用 <code>kubeutil get xxx</code> 去匹配到一些 pod，查看这些 pod 的名字，然后去修改 <code>xxx</code>。</p>
<pre><code class="hljs language-sh">kubeutil <span class="hljs-built_in">exec</span> foo
<span class="hljs-comment"># Oh, get an error!!!</span>

kubeutil get foo
<span class="hljs-comment"># foo-bf47bc459-qkzbv                        1/1     Running   0          15d</span>
<span class="hljs-comment"># foo-7cd5bdd6cc-8n6vd                       1/1     Running   0          19d</span>

kubeutil <span class="hljs-built_in">exec</span> foo-bf
<span class="hljs-comment"># it worked!</span>
</code></pre>
<p>我们能做的更好吗？</p>
<p>我们可以将 <code>kubeutil</code> 做成交互式的</p>
<pre><code class="hljs language-sh">$ kubeutil <span class="hljs-built_in">exec</span> foo                   <span class="hljs-comment"># 运行指令，输出匹配到的 pod，并附上 index，让用户选择要登录到哪个 pod</span>
0 foo-bf47bc459-qkzbv
1 foo-7cd5bdd6cc-8n6vd
Enter the index of pod that you want to <span class="hljs-keyword">select</span> > 1  <span class="hljs-comment"># 用户输入 1，表示选择登录到 `foo-7cd5bdd6cc-8n6vd`</span>
</code></pre>
<p>完整代码</p>
<pre><code class="hljs language-bash"><span class="hljs-meta">#!/bin/bash</span>

NAMESPACE=<span class="hljs-string">"xxx"</span>

RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-keyword">function</span> select_pod {
    <span class="hljs-built_in">local</span> pod_names=($( kubectl get pods -n <span class="hljs-variable">$NAMESPACE</span> | grep <span class="hljs-variable">$1</span> | awk <span class="hljs-string">'{print $1}'</span> ))

    <span class="hljs-built_in">local</span> selected_pod=<span class="hljs-string">"<span class="hljs-variable">${pod_names[0]}</span>"</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">${#pod_names[@]}</span> -gt 1 ]]
    <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># display pod name line by line with index</span>
        <span class="hljs-built_in">local</span> i=0
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${pod_names[@]}</span>"</span>
        <span class="hljs-keyword">do</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-variable">$i</span> <span class="hljs-variable">$name</span> >&#x26;2
            i=$((i+<span class="hljs-number">1</span>))
        <span class="hljs-keyword">done</span>

        <span class="hljs-comment"># read the user input</span>
        <span class="hljs-built_in">echo</span> -e -n <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>Enter the index of the pod you want to select > <span class="hljs-variable">${NC}</span>"</span> >&#x26;2
        <span class="hljs-built_in">read</span> index
        selected_pod=<span class="hljs-string">"<span class="hljs-variable">${pod_names[$index]}</span>"</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$selected_pod</span>
}

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 2 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>error<span class="hljs-variable">${NC}</span>: please specify 2 command line arguments"</span>
		<span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span>
    get)
        kubectl get pods -n <span class="hljs-variable">$NAMESPACE</span> | grep <span class="hljs-variable">$2</span>
    ;;

    <span class="hljs-built_in">log</span>)
        selected_pod=$( select_pod <span class="hljs-variable">$2</span> )
        kubectl logs -n <span class="hljs-variable">$NAMESPACE</span> <span class="hljs-variable">$selected_pod</span>
    ;;

    <span class="hljs-built_in">exec</span>)
        selected_pod=$( select_pod <span class="hljs-variable">$2</span> )
        kubectl <span class="hljs-built_in">exec</span> -n <span class="hljs-variable">$NAMESPACE</span> -it <span class="hljs-variable">$selected_pod</span> /bin/bash
    ;;

    *)
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>error: <span class="hljs-variable">${NC}</span>unsupported command"</span>
    ;;
<span class="hljs-keyword">esac</span>
</code></pre></div></article></main><div class="mt-12"><a href="/">← 返回首页</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"05_kubeutil","contentHtml":"\u003cp\u003e这篇文章介绍了我最常用的 3 个 \u003ccode\u003ekubectl\u003c/code\u003e 命令，以及如何使用 bash 脚本将它们封装成我喜欢的样子。\u003c/p\u003e\n\u003cp\u003e最近开始用 \u003ccode\u003ekubectl\u003c/code\u003e，发现有几个命令高频出现，下面来看一下这几个命令。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e查询 pod 的运行状态\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003ekubectl get pods -n NAMESPACE | grep NAME_PATTERN\n\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e查询某个 pod 的日志\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003ekubectl get pods -n NAMESPACE | grep xxx | awk \u003cspan class=\"hljs-string\"\u003e'{print $1}'\u003c/span\u003e | xargs kubectl logs -n NAMESPACE\n\u003c/code\u003e\u003c/pre\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e登录到某个 pod\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003ekubectl get pods -n NAMESPACE | grep xxx | awk \u003cspan class=\"hljs-string\"\u003e'{print $1}'\u003c/span\u003e | xargs -I {} kubectl \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e -n NAMESPACE -it {} /bin/bash\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e每次都要敲这么多字符才能达成我们想要的结果，基本都是重复的东西，很容易想到我们可以把这几个命令写成 bash 脚本，假设这个脚本叫 \u003ccode\u003ekubeutil\u003c/code\u003e，\n预期的接口是\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e\u003cspan class=\"hljs-comment\"\u003e# 获取名字中包含 “xxx” 的 pod 的运行状态\u003c/span\u003e\nkubeutil get xxx\n\n\u003cspan class=\"hljs-comment\"\u003e# 获取名字中包含 “xxx” 的 pod 的日志\u003c/span\u003e\nkubeutil \u003cspan class=\"hljs-built_in\"\u003elog\u003c/span\u003e xxx\n\n\u003cspan class=\"hljs-comment\"\u003e# 登录到名字中包含 “xxx” 的 pod\u003c/span\u003e\nkubeutil \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e xxx\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ekubeutil log\u003c/code\u003e 和 \u003ccode\u003ekubeutil exec\u003c/code\u003e 这两个脚本在逻辑上有个明显的漏洞，我们用 \u003ccode\u003egrep xxx\u003c/code\u003e 去匹配 pod 名字中包含 \"xxx\" 的 pod，如果有不止一个 pod 满足匹配要求呢？应该获取哪个 pod 的日志呢？登录进哪个 pod 呢？\u003c/p\u003e\n\u003cp\u003e我们需要使 \u003ccode\u003egrep xxx\u003c/code\u003e 只匹配唯一一个 pod，那就得下更多的功夫在 \u003ccode\u003exxx\u003c/code\u003e 上，得找到合适的匹配规则。实际上这让我很头疼，我总是需要先用 \u003ccode\u003ekubeutil get xxx\u003c/code\u003e 去匹配到一些 pod，查看这些 pod 的名字，然后去修改 \u003ccode\u003exxx\u003c/code\u003e。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003ekubeutil \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e foo\n\u003cspan class=\"hljs-comment\"\u003e# Oh, get an error!!!\u003c/span\u003e\n\nkubeutil get foo\n\u003cspan class=\"hljs-comment\"\u003e# foo-bf47bc459-qkzbv                        1/1     Running   0          15d\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# foo-7cd5bdd6cc-8n6vd                       1/1     Running   0          19d\u003c/span\u003e\n\nkubeutil \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e foo-bf\n\u003cspan class=\"hljs-comment\"\u003e# it worked!\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e我们能做的更好吗？\u003c/p\u003e\n\u003cp\u003e我们可以将 \u003ccode\u003ekubeutil\u003c/code\u003e 做成交互式的\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e$ kubeutil \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e foo                   \u003cspan class=\"hljs-comment\"\u003e# 运行指令，输出匹配到的 pod，并附上 index，让用户选择要登录到哪个 pod\u003c/span\u003e\n0 foo-bf47bc459-qkzbv\n1 foo-7cd5bdd6cc-8n6vd\nEnter the index of pod that you want to \u003cspan class=\"hljs-keyword\"\u003eselect\u003c/span\u003e \u003e 1  \u003cspan class=\"hljs-comment\"\u003e# 用户输入 1，表示选择登录到 `foo-7cd5bdd6cc-8n6vd`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e完整代码\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-meta\"\u003e#!/bin/bash\u003c/span\u003e\n\nNAMESPACE=\u003cspan class=\"hljs-string\"\u003e\"xxx\"\u003c/span\u003e\n\nRED=\u003cspan class=\"hljs-string\"\u003e'\\033[0;31m'\u003c/span\u003e\nGREEN=\u003cspan class=\"hljs-string\"\u003e'\\033[0;32m'\u003c/span\u003e\nYELLOW=\u003cspan class=\"hljs-string\"\u003e'\\033[1;33m'\u003c/span\u003e\nNC=\u003cspan class=\"hljs-string\"\u003e'\\033[0m'\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e select_pod {\n    \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e pod_names=($( kubectl get pods -n \u003cspan class=\"hljs-variable\"\u003e$NAMESPACE\u003c/span\u003e | grep \u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e | awk \u003cspan class=\"hljs-string\"\u003e'{print $1}'\u003c/span\u003e ))\n\n    \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e selected_pod=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${pod_names[0]}\u003c/span\u003e\"\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [[ \u003cspan class=\"hljs-variable\"\u003e${#pod_names[@]}\u003c/span\u003e -gt 1 ]]\n    \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-comment\"\u003e# display pod name line by line with index\u003c/span\u003e\n        \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e i=0\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e name \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${pod_names[@]}\u003c/span\u003e\"\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n            \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$name\u003c/span\u003e \u003e\u0026#x26;2\n            i=$((i+\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e))\n        \u003cspan class=\"hljs-keyword\"\u003edone\u003c/span\u003e\n\n        \u003cspan class=\"hljs-comment\"\u003e# read the user input\u003c/span\u003e\n        \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e -e -n \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${GREEN}\u003c/span\u003eEnter the index of the pod you want to select \u003e \u003cspan class=\"hljs-variable\"\u003e${NC}\u003c/span\u003e\"\u003c/span\u003e \u003e\u0026#x26;2\n        \u003cspan class=\"hljs-built_in\"\u003eread\u003c/span\u003e index\n        selected_pod=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${pod_names[$index]}\u003c/span\u003e\"\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$selected_pod\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-variable\"\u003e$#\u003c/span\u003e -ne 2 ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n        \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e -e \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${RED}\u003c/span\u003eerror\u003cspan class=\"hljs-variable\"\u003e${NC}\u003c/span\u003e: please specify 2 command line arguments\"\u003c/span\u003e\n\t\t\u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e 1\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e\n    get)\n        kubectl get pods -n \u003cspan class=\"hljs-variable\"\u003e$NAMESPACE\u003c/span\u003e | grep \u003cspan class=\"hljs-variable\"\u003e$2\u003c/span\u003e\n    ;;\n\n    \u003cspan class=\"hljs-built_in\"\u003elog\u003c/span\u003e)\n        selected_pod=$( select_pod \u003cspan class=\"hljs-variable\"\u003e$2\u003c/span\u003e )\n        kubectl logs -n \u003cspan class=\"hljs-variable\"\u003e$NAMESPACE\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$selected_pod\u003c/span\u003e\n    ;;\n\n    \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e)\n        selected_pod=$( select_pod \u003cspan class=\"hljs-variable\"\u003e$2\u003c/span\u003e )\n        kubectl \u003cspan class=\"hljs-built_in\"\u003eexec\u003c/span\u003e -n \u003cspan class=\"hljs-variable\"\u003e$NAMESPACE\u003c/span\u003e -it \u003cspan class=\"hljs-variable\"\u003e$selected_pod\u003c/span\u003e /bin/bash\n    ;;\n\n    *)\n        \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e -e \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${RED}\u003c/span\u003eerror: \u003cspan class=\"hljs-variable\"\u003e${NC}\u003c/span\u003eunsupported command\"\u003c/span\u003e\n    ;;\n\u003cspan class=\"hljs-keyword\"\u003eesac\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e","title":"封装我最常用的 3 个 kubectl 命令","date":"2022-08-17"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"05_kubeutil"},"buildId":"NuG4xb_OUEJ1r6hPWds1R","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>