<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>Salsa: dependency 理解纠正</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/dba152634a942a1a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dba152634a942a1a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/69a316e8a13b4830.css" as="style"/><link rel="stylesheet" href="/_next/static/css/69a316e8a13b4830.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-e70c6273bfe3f237.js" defer=""></script><script src="/_next/static/chunks/main-d719a31ca00eb19c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-fcb060ba8fa2b368.js" defer=""></script><script src="/_next/static/chunks/640-1a3a0dc0790efd2e.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-03d1a37039c741de.js" defer=""></script><script src="/_next/static/KKVTGzyKFvj8chyCXvLLW/_buildManifest.js" defer=""></script><script src="/_next/static/KKVTGzyKFvj8chyCXvLLW/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><main><article><h1 class="utils_headingXl__u25Y2">Salsa: dependency 理解纠正</h1><div class="utils_lightText__eUzGY"><time dateTime="2022-09-02">September 2, 2022</time></div><div><p>通过一个简单的例子，发现我对 Salsa dependency 理解有误</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::input]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyInput</span> {
    field: <span class="hljs-type">i32</span>
}

<span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(db: &#x26;<span class="hljs-keyword">dyn</span> Db, input: MyInput) <span class="hljs-punctuation">-></span> <span class="hljs-type">i32</span> {
    <span class="hljs-number">0</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    ...
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">input</span> = MyInput::<span class="hljs-title function_ invoke__">new</span>(&#x26;<span class="hljs-keyword">mut</span> db, <span class="hljs-number">22</span>);
    <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input);
    input.<span class="hljs-title function_ invoke__">set_field</span>(&#x26;<span class="hljs-keyword">mut</span> db, <span class="hljs-number">44</span>);
    <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input);
}
</code></pre>
<p>第二次调用 <code>tracked_fn(&#x26;db, input)</code> 能重用第一次的计算结果吗？</p>
<p><code>tracked_fn(&#x26;db, input)</code> 需不需要重新计算，需要考虑 dependencies 有没有变化。这句话听着很简单，也很合理，但是我并没有真正理解它。重点不在 dependencies 是什么，而在是 “谁的” dependencies。</p>
<p>回到具体问题，我之前一直认为是 <code>tracked_fn</code> 这个函数本身的 dependencies，那一个函数的 dependencies 就是它的参数以及函数体里调用的其他 tracked function。如果是这样，上述问题的答案就是不能重用，需要重新计算，因为参数发生了改变。</p>
<p>但实际上，Salsa 并不需要重新计算，Salsa 认为的 dependencies 是针对 <code>tracked_fn(&#x26;db, input)</code> 这个计算结果。<code>input</code> 虽然作为参数输入，但在计算时并没有真正被用到，所以 <code>tracked_fn(&#x26;db, input)</code> 并不依赖 <code>input</code>，它的改变对结果不会有任何影响，所以不需要重新计算。</p>
<p>再来看一个例子，对于 <code>input = MyInput::new(&#x26;mut db, 1)</code>，<code>tracked_fn(&#x26;db, input)</code> 依赖 <code>tracked_extra(db, input)</code> 吗？对于 <code>input = MyInput::new(&#x26;mut db, -1)</code> 呢？</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(db: &#x26;<span class="hljs-keyword">dyn</span> Db, input MyInput) <span class="hljs-punctuation">-></span> <span class="hljs-type">i32</span> {
    <span class="hljs-keyword">if</span> input.<span class="hljs-title function_ invoke__">field</span>(db) &#x3C; <span class="hljs-number">0</span> {
        <span class="hljs-title function_ invoke__">tracked_extra</span>(db: &#x26;<span class="hljs-keyword">dyn</span> Db, input)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-number">0</span>
    }
}
</code></pre>
<hr>
<p><strong>UPDATE(2022/9/7)</strong></p>
<p>今天又有一点新的理解，值得一说</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(db: &#x26;<span class="hljs-keyword">dyn</span> Db, input MyInput) <span class="hljs-punctuation">-></span> <span class="hljs-type">i32</span> {
    <span class="hljs-title function_ invoke__">tracked_extra</span>(db: &#x26;<span class="hljs-keyword">dyn</span> Db, input)
}
</code></pre>
<p>上述例子中 <code>tracked_fn(&#x26;db, input)</code> 依赖 <code>input</code> 吗？</p>
<p>不依赖，只依赖 <code>tracked_extra(db: &#x26;dyn Db, input)</code></p></div></article></main><div class="layout_backToHome__9sjx_"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"07_salsa_dependency","contentHtml":"\u003cp\u003e通过一个简单的例子，发现我对 Salsa dependency 理解有误\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::input]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyInput\u003c/span\u003e {\n    field: \u003cspan class=\"hljs-type\"\u003ei32\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db, input: MyInput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003ei32\u003c/span\u003e {\n    \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emain\u003c/span\u003e() {\n    ...\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003einput\u003c/span\u003e = MyInput::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(\u0026#x26;\u003cspan class=\"hljs-keyword\"\u003emut\u003c/span\u003e db, \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input);\n    input.\u003cspan class=\"hljs-title function_ invoke__\"\u003eset_field\u003c/span\u003e(\u0026#x26;\u003cspan class=\"hljs-keyword\"\u003emut\u003c/span\u003e db, \u003cspan class=\"hljs-number\"\u003e44\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e第二次调用 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 能重用第一次的计算结果吗？\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 需不需要重新计算，需要考虑 dependencies 有没有变化。这句话听着很简单，也很合理，但是我并没有真正理解它。重点不在 dependencies 是什么，而在是 “谁的” dependencies。\u003c/p\u003e\n\u003cp\u003e回到具体问题，我之前一直认为是 \u003ccode\u003etracked_fn\u003c/code\u003e 这个函数本身的 dependencies，那一个函数的 dependencies 就是它的参数以及函数体里调用的其他 tracked function。如果是这样，上述问题的答案就是不能重用，需要重新计算，因为参数发生了改变。\u003c/p\u003e\n\u003cp\u003e但实际上，Salsa 并不需要重新计算，Salsa 认为的 dependencies 是针对 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 这个计算结果。\u003ccode\u003einput\u003c/code\u003e 虽然作为参数输入，但在计算时并没有真正被用到，所以 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 并不依赖 \u003ccode\u003einput\u003c/code\u003e，它的改变对结果不会有任何影响，所以不需要重新计算。\u003c/p\u003e\n\u003cp\u003e再来看一个例子，对于 \u003ccode\u003einput = MyInput::new(\u0026#x26;mut db, 1)\u003c/code\u003e，\u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 依赖 \u003ccode\u003etracked_extra(db, input)\u003c/code\u003e 吗？对于 \u003ccode\u003einput = MyInput::new(\u0026#x26;mut db, -1)\u003c/code\u003e 呢？\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db, input MyInput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003ei32\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e input.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e {\n        \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_extra\u003c/span\u003e(db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db, input)\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n        \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cstrong\u003eUPDATE(2022/9/7)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e今天又有一点新的理解，值得一说\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db, input MyInput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003ei32\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_extra\u003c/span\u003e(db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db, input)\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e上述例子中 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 依赖 \u003ccode\u003einput\u003c/code\u003e 吗？\u003c/p\u003e\n\u003cp\u003e不依赖，只依赖 \u003ccode\u003etracked_extra(db: \u0026#x26;dyn Db, input)\u003c/code\u003e\u003c/p\u003e","title":"Salsa: dependency 理解纠正","date":"2022-09-02"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"07_salsa_dependency"},"buildId":"KKVTGzyKFvj8chyCXvLLW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>