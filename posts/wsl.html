<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>安装配置 WSL2</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/ab65974685f462b8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ab65974685f462b8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-6cbe6e332df95288.js" defer=""></script><script src="/_next/static/chunks/main-26f9f36b33181737.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d6bf7b3192a8752.js" defer=""></script><script src="/_next/static/chunks/73-96e6cbd54826b874.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4b57e02c440700a5.js" defer=""></script><script src="/_next/static/639Ox_e6KcvOQ7l5p__VL/_buildManifest.js" defer=""></script><script src="/_next/static/639Ox_e6KcvOQ7l5p__VL/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-4xl px-4 mt-12 mb-24 mx-auto"><main><article><h1 class="text-3xl font-medium my-4 border-b-0">安装配置 WSL2</h1><div class="text-gray-500 mb-8 pb-2 border-b-2 border-solid border-slate-300"><time dateTime="2023-09-21">September 21, 2023</time></div><div><h2>安装 WSL2</h2>
<p>按照官网 <a href="https://learn.microsoft.com/en-us/windows/wsl/install#install-wsl-command">How to install Linux on Windows with WSL</a> 的步骤安装 WSL2。下面是我安装的步骤：</p>
<p>管理员身份运行 powershell，执行以下命令：</p>
<pre><code>wsl --install
</code></pre>
<p>重启电脑</p>
<p>执行 <code>wsl --list</code> 查看已安装的 distro，但是显示没有安装任何 distro。官方文档的意思是执行完 <code>wsl --install</code> 后会自动安装 Ubuntu，但是我这里没有自动安装 Ubuntu。然后我发现在应用程序列表中有一个 Ubuntu，点击它，按照提示安装 Ubuntu，然后就可以在 <code>wsl --list</code> 的输出中看到 Ubuntu 了。现在可以使用 <code>wsl</code> 命令进入 Ubuntu。</p>
<p><img src="/wsl/20230921075234.png" alt=""></p>
<h2>配置代理</h2>
<p>前置条件：</p>
<ol>
<li>在 Windows 是使用 clash for windows 作为代理</li>
<li>代理的端口是 7890</li>
</ol>
<pre><code class="hljs language-bash"><span class="hljs-meta">#!/bin/sh</span>
hostip=$(<span class="hljs-built_in">cat</span> /etc/resolv.conf | grep nameserver | awk <span class="hljs-string">'{ print $2 }'</span>)
wslip=$(hostname -I | awk <span class="hljs-string">'{print $1}'</span>)
port=7890

PROXY_HTTP=<span class="hljs-string">"http://<span class="hljs-variable">${hostip}</span>:<span class="hljs-variable">${port}</span>"</span>

<span class="hljs-function"><span class="hljs-title">set_proxy</span></span>(){
    <span class="hljs-built_in">export</span> http_proxy=<span class="hljs-string">"<span class="hljs-variable">${PROXY_HTTP}</span>"</span>
    <span class="hljs-built_in">export</span> HTTP_PROXY=<span class="hljs-string">"<span class="hljs-variable">${PROXY_HTTP}</span>"</span>

    <span class="hljs-built_in">export</span> https_proxy=<span class="hljs-string">"<span class="hljs-variable">${PROXY_HTTP}</span>"</span>
    <span class="hljs-built_in">export</span> HTTPS_proxy=<span class="hljs-string">"<span class="hljs-variable">${PROXY_HTTP}</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">unset_proxy</span></span>(){
    <span class="hljs-built_in">unset</span> http_proxy
    <span class="hljs-built_in">unset</span> HTTP_PROXY
    <span class="hljs-built_in">unset</span> https_proxy
    <span class="hljs-built_in">unset</span> HTTPS_PROXY
}

<span class="hljs-function"><span class="hljs-title">test_setting</span></span>(){
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Host ip:"</span> <span class="hljs-variable">${hostip}</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"WSL ip:"</span> <span class="hljs-variable">${wslip}</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Current proxy:"</span> <span class="hljs-variable">$https_proxy</span>
}

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">"set"</span> ]
<span class="hljs-keyword">then</span>
    set_proxy
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Proxy set to <span class="hljs-variable">${PROXY_HTTP}</span>"</span>

<span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">"unset"</span> ]
<span class="hljs-keyword">then</span>
    unset_proxy

<span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">"test"</span> ]
<span class="hljs-keyword">then</span>
    test_setting
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Unsupported arguments."</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<pre><code class="hljs language-shell">source proxy.sh set
</code></pre>
<p>用 <code>curl -v www.google.com</code> 测试，发现代理不起作用。</p>
<p>在 clash for windows 中，开启 <code>Allow LAN</code> 选项，就可以了。</p>
<p><img src="/wsl/20230921080117.png" alt=""></p>
<h2>配置 terminal 以及常用命令行工具</h2>
<h3>安装 Nix</h3>
<p>使用 <a href="https://github.com/DeterminateSystems/nix-installer">nix-installer</a> 安装</p>
<pre><code class="hljs language-shell">curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
</code></pre>
<h3>安装 home-manager</h3>
<p>按照 <a href="https://nix-community.github.io/home-manager/index.html#sec-install-standalone">install standalone</a> 安装。</p>
<p>不过安装巨慢，感觉是 <code>nix-shell</code> 没有读取走代理。</p>
<p>参考 <a href="https://github.com/NixOS/nixpkgs/issues/27535#issuecomment-1178444327">https://github.com/NixOS/nixpkgs/issues/27535#issuecomment-1178444327</a> 的方案配置代理，下面是整理的适合 wsl 的脚本：</p>
<pre><code class="hljs language-bash"><span class="hljs-meta">#!/bin/sh</span>
hostip=$(<span class="hljs-built_in">cat</span> /etc/resolv.conf | grep nameserver | awk <span class="hljs-string">'{ print $2 }'</span>)
wslip=$(hostname -I | awk <span class="hljs-string">'{print $1}'</span>)
port=7890

PROXY_HTTP=<span class="hljs-string">"http://<span class="hljs-variable">${hostip}</span>:<span class="hljs-variable">${port}</span>"</span>

sudo <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/nix-daemon.service.d/
<span class="hljs-built_in">cat</span> &#x3C;&#x3C; <span class="hljs-string">EOF | sudo tee /etc/systemd/system/nix-daemon.service.d/override.conf >/dev/null
[Service]
Environment="http_proxy=${PROXY_HTTP}"
Environment="https_proxy=${PROXY_HTTP}"
Environment="all_proxy=${PROXY_HTTP}"
EOF</span>
sudo systemctl daemon-reload
sudo systemctl restart nix-daemon
</code></pre>
<h4>配置 home-manager</h4>
<pre><code class="hljs language-shell">git clone https://github.com/xffxff/nixfiles

ln -s /path/to/nixfiles ~/.config/home-manager

home-manager switch
</code></pre>
<p>大功告成，不过有个瑕疵是 terminal 的字体不对，zsh 主题有些图标显示为乱码。</p>
<p><img src="/wsl/20230921090053.png" alt=""></p>
<p>下载 <a href="https://github.com/ryanoasis/nerd-fonts/blob/master/patched-fonts/Meslo/M/Regular/MesloLGMNerdFont-Regular.ttf">Meslo LGM Nerd Font</a> 并安装。</p>
<p>然后在 Windows Terminal 中将字体设置为 MesloLGM Nerd Font</p>
<p><img src="/wsl/20230921090242.png" alt=""></p>
<p>现在看起来好多了。</p>
<p><img src="/wsl/20230921090418.png" alt=""></p></div></article></main><div class="mt-12"><a href="/">← 返回首页</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"wsl","contentHtml":"\u003ch2\u003e安装 WSL2\u003c/h2\u003e\n\u003cp\u003e按照官网 \u003ca href=\"https://learn.microsoft.com/en-us/windows/wsl/install#install-wsl-command\"\u003eHow to install Linux on Windows with WSL\u003c/a\u003e 的步骤安装 WSL2。下面是我安装的步骤：\u003c/p\u003e\n\u003cp\u003e管理员身份运行 powershell，执行以下命令：\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ewsl --install\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e重启电脑\u003c/p\u003e\n\u003cp\u003e执行 \u003ccode\u003ewsl --list\u003c/code\u003e 查看已安装的 distro，但是显示没有安装任何 distro。官方文档的意思是执行完 \u003ccode\u003ewsl --install\u003c/code\u003e 后会自动安装 Ubuntu，但是我这里没有自动安装 Ubuntu。然后我发现在应用程序列表中有一个 Ubuntu，点击它，按照提示安装 Ubuntu，然后就可以在 \u003ccode\u003ewsl --list\u003c/code\u003e 的输出中看到 Ubuntu 了。现在可以使用 \u003ccode\u003ewsl\u003c/code\u003e 命令进入 Ubuntu。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/wsl/20230921075234.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2\u003e配置代理\u003c/h2\u003e\n\u003cp\u003e前置条件：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e在 Windows 是使用 clash for windows 作为代理\u003c/li\u003e\n\u003cli\u003e代理的端口是 7890\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-meta\"\u003e#!/bin/sh\u003c/span\u003e\nhostip=$(\u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /etc/resolv.conf | grep nameserver | awk \u003cspan class=\"hljs-string\"\u003e'{ print $2 }'\u003c/span\u003e)\nwslip=$(hostname -I | awk \u003cspan class=\"hljs-string\"\u003e'{print $1}'\u003c/span\u003e)\nport=7890\n\nPROXY_HTTP=\u003cspan class=\"hljs-string\"\u003e\"http://\u003cspan class=\"hljs-variable\"\u003e${hostip}\u003c/span\u003e:\u003cspan class=\"hljs-variable\"\u003e${port}\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003eset_proxy\u003c/span\u003e\u003c/span\u003e(){\n    \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e http_proxy=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${PROXY_HTTP}\u003c/span\u003e\"\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e HTTP_PROXY=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${PROXY_HTTP}\u003c/span\u003e\"\u003c/span\u003e\n\n    \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e https_proxy=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${PROXY_HTTP}\u003c/span\u003e\"\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e HTTPS_proxy=\u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e${PROXY_HTTP}\u003c/span\u003e\"\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003eunset_proxy\u003c/span\u003e\u003c/span\u003e(){\n    \u003cspan class=\"hljs-built_in\"\u003eunset\u003c/span\u003e http_proxy\n    \u003cspan class=\"hljs-built_in\"\u003eunset\u003c/span\u003e HTTP_PROXY\n    \u003cspan class=\"hljs-built_in\"\u003eunset\u003c/span\u003e https_proxy\n    \u003cspan class=\"hljs-built_in\"\u003eunset\u003c/span\u003e HTTPS_PROXY\n}\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003etest_setting\u003c/span\u003e\u003c/span\u003e(){\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Host ip:\"\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e${hostip}\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"WSL ip:\"\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e${wslip}\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Current proxy:\"\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$https_proxy\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e\"\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"set\"\u003c/span\u003e ]\n\u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    set_proxy\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Proxy set to \u003cspan class=\"hljs-variable\"\u003e${PROXY_HTTP}\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e\"\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"unset\"\u003c/span\u003e ]\n\u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    unset_proxy\n\n\u003cspan class=\"hljs-keyword\"\u003eelif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e\"\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e\"\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\"test\"\u003c/span\u003e ]\n\u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    test_setting\n\u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"Unsupported arguments.\"\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003esource proxy.sh set\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e用 \u003ccode\u003ecurl -v www.google.com\u003c/code\u003e 测试，发现代理不起作用。\u003c/p\u003e\n\u003cp\u003e在 clash for windows 中，开启 \u003ccode\u003eAllow LAN\u003c/code\u003e 选项，就可以了。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/wsl/20230921080117.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2\u003e配置 terminal 以及常用命令行工具\u003c/h2\u003e\n\u003ch3\u003e安装 Nix\u003c/h3\u003e\n\u003cp\u003e使用 \u003ca href=\"https://github.com/DeterminateSystems/nix-installer\"\u003enix-installer\u003c/a\u003e 安装\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003ecurl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003e安装 home-manager\u003c/h3\u003e\n\u003cp\u003e按照 \u003ca href=\"https://nix-community.github.io/home-manager/index.html#sec-install-standalone\"\u003einstall standalone\u003c/a\u003e 安装。\u003c/p\u003e\n\u003cp\u003e不过安装巨慢，感觉是 \u003ccode\u003enix-shell\u003c/code\u003e 没有读取走代理。\u003c/p\u003e\n\u003cp\u003e参考 \u003ca href=\"https://github.com/NixOS/nixpkgs/issues/27535#issuecomment-1178444327\"\u003ehttps://github.com/NixOS/nixpkgs/issues/27535#issuecomment-1178444327\u003c/a\u003e 的方案配置代理，下面是整理的适合 wsl 的脚本：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-meta\"\u003e#!/bin/sh\u003c/span\u003e\nhostip=$(\u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /etc/resolv.conf | grep nameserver | awk \u003cspan class=\"hljs-string\"\u003e'{ print $2 }'\u003c/span\u003e)\nwslip=$(hostname -I | awk \u003cspan class=\"hljs-string\"\u003e'{print $1}'\u003c/span\u003e)\nport=7890\n\nPROXY_HTTP=\u003cspan class=\"hljs-string\"\u003e\"http://\u003cspan class=\"hljs-variable\"\u003e${hostip}\u003c/span\u003e:\u003cspan class=\"hljs-variable\"\u003e${port}\u003c/span\u003e\"\u003c/span\u003e\n\nsudo \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p /etc/systemd/system/nix-daemon.service.d/\n\u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e \u0026#x3C;\u0026#x3C; \u003cspan class=\"hljs-string\"\u003eEOF | sudo tee /etc/systemd/system/nix-daemon.service.d/override.conf \u003e/dev/null\n[Service]\nEnvironment=\"http_proxy=${PROXY_HTTP}\"\nEnvironment=\"https_proxy=${PROXY_HTTP}\"\nEnvironment=\"all_proxy=${PROXY_HTTP}\"\nEOF\u003c/span\u003e\nsudo systemctl daemon-reload\nsudo systemctl restart nix-daemon\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e配置 home-manager\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003egit clone https://github.com/xffxff/nixfiles\n\nln -s /path/to/nixfiles ~/.config/home-manager\n\nhome-manager switch\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e大功告成，不过有个瑕疵是 terminal 的字体不对，zsh 主题有些图标显示为乱码。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/wsl/20230921090053.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e下载 \u003ca href=\"https://github.com/ryanoasis/nerd-fonts/blob/master/patched-fonts/Meslo/M/Regular/MesloLGMNerdFont-Regular.ttf\"\u003eMeslo LGM Nerd Font\u003c/a\u003e 并安装。\u003c/p\u003e\n\u003cp\u003e然后在 Windows Terminal 中将字体设置为 MesloLGM Nerd Font\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/wsl/20230921090242.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e现在看起来好多了。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/wsl/20230921090418.png\" alt=\"\"\u003e\u003c/p\u003e","title":"安装配置 WSL2","date":"2023-09-21"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"wsl"},"buildId":"639Ox_e6KcvOQ7l5p__VL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>