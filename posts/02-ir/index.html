<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" integrity="sha384-oGm59HWAkwO32h2w8u0B98wKBZJwd6MbWtAJwQKCTffZjOXHXrnyv9Syjovgc+UV" crossorigin="anonymous">
  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" integrity="sha256-rTpdO0HXBCNpreAHcu6tB2Ppg515Vo+5GtYSsnNLz+8=" crossorigin="anonymous">
  <link href="https://xffxff.github.io/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
日拱一卒 | IR 竟然是......

  </title>

  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176984489-2"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "UA-176984489-2");
  </script>
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js" integrity="sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT" crossorigin="anonymous"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
  
  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;xffxff.github.io&#x2F;">日拱一卒</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;xffxff.github.io&#x2F;&#x2F;tags">
            Tags
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            IR 竟然是......
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>XFFXFF published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2022-02-26">February 26, 2022</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>4 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>680 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <blockquote>
<p>When you're programming, it's amazing what a difference the choice of IR can make. I've often found that when something seems too hard, it's because I need to introduce a primary transformation into some form that makes the problem easier. Well, likewise, as we do research, we should think about the medium and tools we are using and make sure they're a good match for our goals.
-- <cite>nikomatsakis</cite></p>
</blockquote>
<p>上面这段话是 nikomatsakis 在 <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/nikomatsakis/plmw-2022">PLWM 2022</a> 上讲的，今天对这段话似乎有了一点理解，记录一下。</p>
<span id="continue-reading"></span>
<p>其实我对 IR (Intermidiate Representation) 的理解一直是模糊的。</p>
<blockquote>
<p>编译器使用一些数据结构来表示它处理的代码，这种形式称为<strong>中间表示</strong>
-- <cite>《编译器设计（第二版）》</cite></p>
</blockquote>
<pre style="background-color:#2b303b;color:#6c7079;"><code><span style="color:#abb2bf;">              +----------------------------+
</span><span style="color:#abb2bf;">              |                            |
</span><span style="color:#abb2bf;">              |                            |
</span><span style="color:#abb2bf;">              |  +--------+ IR  +-------+  |
</span><span style="color:#abb2bf;"> source code  |  |frontend+----&gt;|backend|  | target code
</span><span style="color:#abb2bf;">-------------&gt;|  +--------+     +-------+  +------------&gt;
</span><span style="color:#abb2bf;">              |                            |
</span><span style="color:#abb2bf;">              |                            |
</span><span style="color:#abb2bf;">              |                    compiler|
</span><span style="color:#abb2bf;">              +----------------------------+
</span></code></pre>
<p>上图也出自《编译器设计（第二版）》，难道 IR 位于前端和后端之间，是一个层级？ dada 中有一个大的组件叫 <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/dada-lang/dada/tree/5b5e366465c2bddec7db832a6e6cd6a2b4865c64/components/dada-ir">dada-ir</a>，它包含了非常多的东西，包括 token, syntax expr, syntax tree, validated expr, validated tree。。。我以前一直以为 IR 是一个层级，现在结合定义和 dada 来看，IR 是一个笼统，宽泛的概念，所有在编译过程中帮助表示源代码的数据结构都可以叫做 IR，它并不是一个层级，它可能是一些层级的输出结果。好吧，这还是太抽象了，感觉说的是个屁啊。。。</p>
<pre style="background-color:#2b303b;color:#6c7079;"><code><span style="color:#abb2bf;">              +--------+             +--------+                  +-----------+                    +--------+          +-----------+
</span><span style="color:#abb2bf;">source code   |        |   tokens    |        |   syntax tree    |           |   validated tree   |        |    bir   |           |  output
</span><span style="color:#abb2bf;">------------&gt; | Lexer  | ----------&gt; | Parser |  --------------&gt; | Validator |  ----------------&gt; |Brewery | --------&gt;| Executor  | ---------&gt;
</span><span style="color:#abb2bf;">              |        |             |        |                  |           |                    |        |          |           |
</span><span style="color:#abb2bf;">              +--------+             +--------+                  +-----------+                    +--------+          +-----------+
</span></code></pre>
<p>上图是 dada 编译的流程（其实不准确，dada 编译的数据流向并不是从左到右，参见 <a href="../plwm-note/">Implementing languages for fun and profit 笔记</a> ），图中的 token，syntax tree，validated tree，bir 都是 IR，它们是对源程序表示的不同形式。好吧，IR 并没有啥神秘的，也没有多高级，只是平时不会把 token，syntax tree 叫做 IR 罢了。</p>
<p>IR 是在编译过程中对源程序的中间表示，没有一个明确的规则或者规范约定如何设计这些数据结构，所以 IR 的设计很大程度依赖于开发者的经验和风格。现在就不难理解  nikomatsakis 所说的，设计合适的 IR 对编译器非常重要，引入某个新的 IR 可能会让问题变得非常简单，今天在看 dada 源码的时候，突然体会到了 dada 在某些 IR 设计上的精妙。Parser 并没有单纯生成树结构的 syntax tree，而是引入一个 Item 的 IR，这个 IR 包含 top-level 的定义，目前只有 class 和 function。引入这个 IR 让 name resolution 的过程变得更简单了，不需要去遍历 syntax tree 就可以得到某个文件定义了哪些 Function，哪些 class。</p>
<pre style="background-color:#2b303b;color:#6c7079;"><code><span style="color:#abb2bf;">+----------+
</span><span style="color:#abb2bf;">| [Item]   |          +-------------+
</span><span style="color:#abb2bf;">|          |          | [Function]  |
</span><span style="color:#abb2bf;">| Class    |          |             |
</span><span style="color:#abb2bf;">| Function +--------&gt; | name        |
</span><span style="color:#abb2bf;">+----------+          | effect      |
</span><span style="color:#abb2bf;">                      | parameters  |
</span><span style="color:#abb2bf;">                      | body        |
</span><span style="color:#abb2bf;">                      +-------------+
</span></code></pre>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;xffxff.github.io&#x2F;posts&#x2F;03-an-interesting-example-of-go&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              一个关于 go 语言的有趣例子
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;xffxff.github.io&#x2F;posts&#x2F;01-plwm-note&#x2F;">
              Implementing languages for fun and profit 笔记<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js" integrity="sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js" integrity="sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs" crossorigin="anonymous"></script>
  
  
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js" integrity="sha384-Pulw7+h73841BQIK0LzJCydKRPChJUF9w8h8W0o3h+cLtoyNPJS847bQauLWOTwg" crossorigin="anonymous"></script>
  
  <script src="https://xffxff.github.io/elasticlunr.min.js"></script>
  <script src="https://xffxff.github.io/search_index.en.js"></script><script src="https://xffxff.github.io/js/site.js"></script>

  





  
  
</body>

</html>
