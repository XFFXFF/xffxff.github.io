<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>Rust Analyzer: 为什么要跑 cargo check</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/bfeaa84465eb48d9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/bfeaa84465eb48d9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-6cbe6e332df95288.js" defer=""></script><script src="/_next/static/chunks/main-26f9f36b33181737.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d6bf7b3192a8752.js" defer=""></script><script src="/_next/static/chunks/73-96e6cbd54826b874.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4b57e02c440700a5.js" defer=""></script><script src="/_next/static/P1yhGVbYbNVldIFIXM1qX/_buildManifest.js" defer=""></script><script src="/_next/static/P1yhGVbYbNVldIFIXM1qX/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-4xl px-4 mt-12 mb-24 mx-auto"><main><article><h1 class="text-3xl font-medium my-4 border-b-0">Rust Analyzer: 为什么要跑 cargo check</h1><div class="text-gray-500 mb-8 pb-2 border-b-2 border-solid border-slate-300"><time dateTime="2022-06-04">June 4, 2022</time></div><div><p>为什么每次编辑的时候（严格来说是保存文本的时候），RA 都要跑一遍 <code>cargo check</code> ？记得有朋友抱怨说跑 <code>cargo check</code> 时 ide 很卡，编辑体验很不好，总不能做一件吃力不讨好的事情吧。</p>
<p><img src="/11/status_bar.png" alt=""></p>
<p>原因就是 <code>cargo check</code> 的报错信息对 RA 非常有用，这些报错信息是 RA diagnostics 的重要部分。</p>
<p><img src="/11/vscode.png" alt=""></p>
<p>图中代码 <code>main</code> 函数少了 } ， RA 提示我们有一些错误，其中 <code>this file contains an unclosed delimiter</code> 和 <code>main.rs(1, 11) unclosed delimiter 是 cargo check</code> 给出的，<code>Syntax Error: expected R_CURLY</code> 是 RA 给出的。</p>
<p>整体思路其实挺简单的，起一个线程跑 cargo check --message-format=json ，这个命令会将报错信息以 json 的格式输出，我贴了一段在下面，它包含具体的报错信息（rendered 和 message 字段），错误的级别（level 字段，error or warning）， 错误发生的位置（spans 字段）。有了这些信息后，RA 就可以把它们展示在 ide 界面上。</p>
<pre><code class="hljs language-json"><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"rendered"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error: this file contains an unclosed delimiter\n --> src/main.rs:2:31\n  |\n1 | fn main() {\n  |           - unclosed delimiter\n2 |     println!(\"Hello World!\");\n  |                               ^\n\n"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"this file contains an unclosed delimiter"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"spans"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"byte_end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">11</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"byte_start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"column_end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"column_start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">11</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"expansion"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"file_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main.rs"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"is_primary"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"unclosed delimiter"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"line_end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"line_start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"suggested_replacement"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"suggestion_applicability"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"highlight_end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"highlight_start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">11</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fn main() {"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>一个新的问题蹦了出来，RA 不也是一个 <code>rust</code> 的编译器前端吗，也可以给出报错信息，为啥还要依赖别人的呢？</p>
<p>一是给出清晰易读的报错信息并不是一件容易的事情，既然已经有现成的工具可以用，就没必要自己再重复造轮子。vscode 中可以配置 <code>"rust-analyzer.checkOnSave.enable": false</code> 来关闭 <code>cargo check</code> ，关闭之后，发现 rust-analyzer 做的 diagnostic 非常有限，比如 println! 少打一个 <code>n</code> , RA 并不会报错，也缺少对 ownership 和 borrow check 的检查。</p>
<p>二是 RA 是自己重新写的 parser，使用 <code>cargo check</code> 的好处是 RA 不必保证自己的 grammer 和 rustc 完全一致，只需要保证 rustc 能 parse 的 RA 也能 parse 就行，那些 RA 可以 parse 但实际不被 rustc 接受的，cargo check 可以给出报错信息，对于 Language Server 来说足够了。</p></div></article></main><div class="mt-12"><a href="/">← 返回首页</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"11_ra_cargo_check","contentHtml":"\u003cp\u003e为什么每次编辑的时候（严格来说是保存文本的时候），RA 都要跑一遍 \u003ccode\u003ecargo check\u003c/code\u003e ？记得有朋友抱怨说跑 \u003ccode\u003ecargo check\u003c/code\u003e 时 ide 很卡，编辑体验很不好，总不能做一件吃力不讨好的事情吧。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/11/status_bar.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e原因就是 \u003ccode\u003ecargo check\u003c/code\u003e 的报错信息对 RA 非常有用，这些报错信息是 RA diagnostics 的重要部分。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/11/vscode.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003e图中代码 \u003ccode\u003emain\u003c/code\u003e 函数少了 } ， RA 提示我们有一些错误，其中 \u003ccode\u003ethis file contains an unclosed delimiter\u003c/code\u003e 和 \u003ccode\u003emain.rs(1, 11) unclosed delimiter 是 cargo check\u003c/code\u003e 给出的，\u003ccode\u003eSyntax Error: expected R_CURLY\u003c/code\u003e 是 RA 给出的。\u003c/p\u003e\n\u003cp\u003e整体思路其实挺简单的，起一个线程跑 cargo check --message-format=json ，这个命令会将报错信息以 json 的格式输出，我贴了一段在下面，它包含具体的报错信息（rendered 和 message 字段），错误的级别（level 字段，error or warning）， 错误发生的位置（spans 字段）。有了这些信息后，RA 就可以把它们展示在 ide 界面上。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-attr\"\u003e\"message\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"rendered\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"error: this file contains an unclosed delimiter\\n --\u003e src/main.rs:2:31\\n  |\\n1 | fn main() {\\n  |           - unclosed delimiter\\n2 |     println!(\\\"Hello World!\\\");\\n  |                               ^\\n\\n\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"children\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"code\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"level\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"error\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"message\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"this file contains an unclosed delimiter\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003e\"spans\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"byte_end\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"byte_start\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"column_end\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"column_start\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"expansion\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"file_name\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"src/main.rs\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"is_primary\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"label\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"unclosed delimiter\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"line_end\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"line_start\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"suggested_replacement\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"suggestion_applicability\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003e\u003cspan class=\"hljs-keyword\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003e\"text\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n          \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003e\"highlight_end\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003e\"highlight_start\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"hljs-attr\"\u003e\"text\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"fn main() {\"\u003c/span\u003e\n          \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e一个新的问题蹦了出来，RA 不也是一个 \u003ccode\u003erust\u003c/code\u003e 的编译器前端吗，也可以给出报错信息，为啥还要依赖别人的呢？\u003c/p\u003e\n\u003cp\u003e一是给出清晰易读的报错信息并不是一件容易的事情，既然已经有现成的工具可以用，就没必要自己再重复造轮子。vscode 中可以配置 \u003ccode\u003e\"rust-analyzer.checkOnSave.enable\": false\u003c/code\u003e 来关闭 \u003ccode\u003ecargo check\u003c/code\u003e ，关闭之后，发现 rust-analyzer 做的 diagnostic 非常有限，比如 println! 少打一个 \u003ccode\u003en\u003c/code\u003e , RA 并不会报错，也缺少对 ownership 和 borrow check 的检查。\u003c/p\u003e\n\u003cp\u003e二是 RA 是自己重新写的 parser，使用 \u003ccode\u003ecargo check\u003c/code\u003e 的好处是 RA 不必保证自己的 grammer 和 rustc 完全一致，只需要保证 rustc 能 parse 的 RA 也能 parse 就行，那些 RA 可以 parse 但实际不被 rustc 接受的，cargo check 可以给出报错信息，对于 Language Server 来说足够了。\u003c/p\u003e","title":"Rust Analyzer: 为什么要跑 cargo check","date":"2022-06-04"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"11_ra_cargo_check"},"buildId":"P1yhGVbYbNVldIFIXM1qX","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>