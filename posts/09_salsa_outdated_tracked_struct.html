<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>(WIP) Salsa: Is the tracked struct valid?</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/dba152634a942a1a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dba152634a942a1a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/69a316e8a13b4830.css" as="style"/><link rel="stylesheet" href="/_next/static/css/69a316e8a13b4830.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-e70c6273bfe3f237.js" defer=""></script><script src="/_next/static/chunks/main-d719a31ca00eb19c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-fcb060ba8fa2b368.js" defer=""></script><script src="/_next/static/chunks/640-1a3a0dc0790efd2e.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-03d1a37039c741de.js" defer=""></script><script src="/_next/static/KKVTGzyKFvj8chyCXvLLW/_buildManifest.js" defer=""></script><script src="/_next/static/KKVTGzyKFvj8chyCXvLLW/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><main><article><h1 class="utils_headingXl__u25Y2">(WIP) Salsa: Is the tracked struct valid?</h1><div class="utils_lightText__eUzGY"><time dateTime="2022-09-26">September 26, 2022</time></div><div><p>来来回回讨论了两周，终于把这个 <a href="https://github.com/salsa-rs/salsa/pull/413">PR</a>
合进去了，这是我参与开源项目以来，第一次讨论这么多。通过这个 PR，确实有很多思考，对Salsa 也有了更深入的思考，值得把它们记录下来</p>
<p>Issue: <a href="https://github.com/salsa-rs/salsa/issues/407">https://github.com/salsa-rs/salsa/issues/407</a></p>
<p>PR: <a href="https://github.com/salsa-rs/salsa/pull/413">https://github.com/salsa-rs/salsa/pull/413</a></p>
<h2>问题</h2>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(db: &#x26;Db, input: MyInput) <span class="hljs-punctuation">-></span> MyTracked {
    MyTracked::<span class="hljs-title function_ invoke__">new</span>(db, input.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">2</span>)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    ...
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">input</span> = MyInput::<span class="hljs-title function_ invoke__">new</span>(&#x26;db, <span class="hljs-number">11</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">tracked</span> = <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input);

    input.<span class="hljs-title function_ invoke__">set_field</span>(&#x26;<span class="hljs-keyword">mut</span> db).<span class="hljs-title function_ invoke__">to</span>(<span class="hljs-number">12</span>);
    dbg!(tracked.<span class="hljs-title function_ invoke__">field</span>(&#x26;db));
}
</code></pre>
<p>修改了 <code>input</code>，<code>tracked</code> 还有效吗？对于上面这段代码，希望在调用
<code>tracked.field(&#x26;db)</code> 时 panic。而我们现在的代码，也就是这个 PR 之前，并不会
panic，会返回上次保存的旧值 22。</p>
<h2>Panic if outdated</h2>
<p>对于 tracked struct 的 fields，一旦发现它 outdated，就应该 panic。如果保存的旧值的 <code>verified_at</code> 小于 <code>runtime.current_revision</code>，我们就说这个旧值 outdated。看看我们上面这个例子，改变 input 的时候，<code>runtime.current_revision</code> 就会 +1，大于
<code>tracked.field(&#x26;db)</code> 查询到的值的 <code>verified_at</code>，所以应该 panic。（reference:
<a href="https://github.com/salsa-rs/salsa/issues/407#issuecomment-1244550905">https://github.com/salsa-rs/salsa/issues/407#issuecomment-1244550905</a>）</p>
<p>看起来合理，但这样改之后，之前的测试有的通不过了。</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(db: &#x26;Db, input: MyInput) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">tracked</span> = MyTracked::<span class="hljs-title function_ invoke__">new</span>(db, input.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">2</span>);
    tracked.<span class="hljs-title function_ invoke__">field</span>(db)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    ...
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">input</span> = MyInput::<span class="hljs-title function_ invoke__">new</span>(&#x26;db, <span class="hljs-number">11</span>);
    _ = <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input);

    <span class="hljs-comment">// A "synthetic write" causes the system to act *as though* some</span>
    <span class="hljs-comment">// input of durability `durability` has changed. This is mostly</span>
    <span class="hljs-comment">// useful for profiling scenarios.</span>
    db.<span class="hljs-title function_ invoke__">synthetic_write</span>(salsa::Durabiliby::High);
    _ = <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input); <span class="hljs-comment">// panic</span>
}
</code></pre>
<p>第二次调用 <code>tracked_fn</code> 会 panic，但这段代码在 salsa 中绝对应该是合理的。第二次调用 <code>tracked_fn(&#x26;db, input)</code>，我们发现 db 中保存有之前的计算结果，但它可能是过时的，因为它对应的 <code>verified_at</code> 小于 <code>current_revision</code>。这时，我们需要 <a href="https://github.com/salsa-rs/salsa/blob/2ffe4a78a824acb8c73e77497e4c2c469fcbed37/components/salsa-2022/src/function/maybe_changed_after.rs#L145">deep
verify</a>，检查这个 query 的所有 dependency 在 <code>verified_at</code> 之后有没有改变。（我们在 <a href="./07_salsa_dependency.md">这篇文章</a> 讨论过 query 的 dependency）。对于
<code>tracked_fn(&#x26;db, input)</code> 来说，一个 dependency 就是 <code>tracked.field(db)</code>，显然它的 <code>verified_at</code> 小于 <code>current_revision</code>，前面已经提到</p>
<blockquote>
<p>对于 tracked struct 的 fields，一旦发现它 outdated，就应该 panic。如果保存的旧
值的 <code>verified_at</code> 小于 <code>runtime.current_revision</code>，我们就说这个旧值
outdated。</p>
</blockquote>
<h2>Is it really outdated?</h2>
<p>上一节中 <code>tracked.field(db)</code> 其实是可用的，我们单纯用它的 <code>verified_at</code> 做比较是有漏洞的。这个场景的特殊之处在于 <code>tracked.field(db)</code> 既是 <code>tracked_fn(&#x26;db, input)</code>这个 query 的 input，也是其 output。<code>tracked.field(db)</code> 是在
<code>MyTracked::new</code> 中被创建的，所以是这个 query 的 output。所以，我们能不能加上一条限制：如果某个 dependency/input 同样也是该 query 的 output，我们就认为这个
dependency/input 是有效的。</p>
<p>很遗憾，这仍然有漏洞，看下面这个例子。</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(db: &#x26;Db, input: MyInput) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">tracked</span> = MyTracked::<span class="hljs-title function_ invoke__">new</span>(db, input.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">2</span>);
    <span class="hljs-title function_ invoke__">tracked_fn_extra</span>(tracked)
}

<span class="hljs-meta">#[salsa::tracked]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn_extra</span>(db: &#x26;Db, tracked: MyTracked) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
    tracked.<span class="hljs-title function_ invoke__">field</span>(db)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    ...
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">input</span> = MyInput::<span class="hljs-title function_ invoke__">new</span>(&#x26;db, <span class="hljs-number">11</span>);
    _ = <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input);

    <span class="hljs-comment">// A "synthetic write" causes the system to act *as though* some</span>
    <span class="hljs-comment">// input of durability `durability` has changed. This is mostly</span>
    <span class="hljs-comment">// useful for profiling scenarios.</span>
    db.<span class="hljs-title function_ invoke__">synthetic_write</span>(salsa::Durabiliby::High);
    _ = <span class="hljs-title function_ invoke__">tracked_fn</span>(&#x26;db, input); <span class="hljs-comment">// panic</span>
}
</code></pre>
<h2>Query</h2>
<blockquote>
<p>Salsa is a query based increamental computation system.</p>
</blockquote>
<p>Query 一词经常在 Salsa 中提到，那到底什么是 query 呢？是 <code>tracked_fn</code> 这个函数吗？我的理解是 <code>tracked_fn(&#x26;db, input)</code> 这个调用？当然
<code>input.field(db)</code>，<code>tracked.field(&#x26;db)</code> 都是 query。</p>
<p>个人认为在 Salsa 代码中，<code>DatabaseKeyIndex</code>、<code>DependencyIndex</code> 和 <code>Memo</code> 都对应一个 query。</p>
<h2>Input &#x26; Output</h2>
<p>这里所说的 input 不是 <code>salsa::input</code>，Input 和 output 都是对 query 而言的。Input
就是这个 query 依赖的其他 query，我们在<a href="./07_salsa_dependency.md">这篇文章</a>中讨论过。Query 的 output 有 3 种：</p>
<ul>
<li>tracked strcuts created</li>
<li>invacations of specify</li>
<li>accumulators pushed to</li>
</ul></div></article></main><div class="layout_backToHome__9sjx_"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"09_salsa_outdated_tracked_struct","contentHtml":"\u003cp\u003e来来回回讨论了两周，终于把这个 \u003ca href=\"https://github.com/salsa-rs/salsa/pull/413\"\u003ePR\u003c/a\u003e\n合进去了，这是我参与开源项目以来，第一次讨论这么多。通过这个 PR，确实有很多思考，对Salsa 也有了更深入的思考，值得把它们记录下来\u003c/p\u003e\n\u003cp\u003eIssue: \u003ca href=\"https://github.com/salsa-rs/salsa/issues/407\"\u003ehttps://github.com/salsa-rs/salsa/issues/407\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003ePR: \u003ca href=\"https://github.com/salsa-rs/salsa/pull/413\"\u003ehttps://github.com/salsa-rs/salsa/pull/413\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e问题\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(db: \u0026#x26;Db, input: MyInput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e MyTracked {\n    MyTracked::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(db, input.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emain\u003c/span\u003e() {\n    ...\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003einput\u003c/span\u003e = MyInput::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(\u0026#x26;db, \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e);\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003etracked\u003c/span\u003e = \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input);\n\n    input.\u003cspan class=\"hljs-title function_ invoke__\"\u003eset_field\u003c/span\u003e(\u0026#x26;\u003cspan class=\"hljs-keyword\"\u003emut\u003c/span\u003e db).\u003cspan class=\"hljs-title function_ invoke__\"\u003eto\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e);\n    dbg!(tracked.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(\u0026#x26;db));\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e修改了 \u003ccode\u003einput\u003c/code\u003e，\u003ccode\u003etracked\u003c/code\u003e 还有效吗？对于上面这段代码，希望在调用\n\u003ccode\u003etracked.field(\u0026#x26;db)\u003c/code\u003e 时 panic。而我们现在的代码，也就是这个 PR 之前，并不会\npanic，会返回上次保存的旧值 22。\u003c/p\u003e\n\u003ch2\u003ePanic if outdated\u003c/h2\u003e\n\u003cp\u003e对于 tracked struct 的 fields，一旦发现它 outdated，就应该 panic。如果保存的旧值的 \u003ccode\u003everified_at\u003c/code\u003e 小于 \u003ccode\u003eruntime.current_revision\u003c/code\u003e，我们就说这个旧值 outdated。看看我们上面这个例子，改变 input 的时候，\u003ccode\u003eruntime.current_revision\u003c/code\u003e 就会 +1，大于\n\u003ccode\u003etracked.field(\u0026#x26;db)\u003c/code\u003e 查询到的值的 \u003ccode\u003everified_at\u003c/code\u003e，所以应该 panic。（reference:\n\u003ca href=\"https://github.com/salsa-rs/salsa/issues/407#issuecomment-1244550905\"\u003ehttps://github.com/salsa-rs/salsa/issues/407#issuecomment-1244550905\u003c/a\u003e）\u003c/p\u003e\n\u003cp\u003e看起来合理，但这样改之后，之前的测试有的通不过了。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(db: \u0026#x26;Db, input: MyInput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003etracked\u003c/span\u003e = MyTracked::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(db, input.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n    tracked.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db)\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emain\u003c/span\u003e() {\n    ...\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003einput\u003c/span\u003e = MyInput::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(\u0026#x26;db, \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e);\n    _ = \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input);\n\n    \u003cspan class=\"hljs-comment\"\u003e// A \"synthetic write\" causes the system to act *as though* some\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// input of durability `durability` has changed. This is mostly\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// useful for profiling scenarios.\u003c/span\u003e\n    db.\u003cspan class=\"hljs-title function_ invoke__\"\u003esynthetic_write\u003c/span\u003e(salsa::Durabiliby::High);\n    _ = \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input); \u003cspan class=\"hljs-comment\"\u003e// panic\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e第二次调用 \u003ccode\u003etracked_fn\u003c/code\u003e 会 panic，但这段代码在 salsa 中绝对应该是合理的。第二次调用 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e，我们发现 db 中保存有之前的计算结果，但它可能是过时的，因为它对应的 \u003ccode\u003everified_at\u003c/code\u003e 小于 \u003ccode\u003ecurrent_revision\u003c/code\u003e。这时，我们需要 \u003ca href=\"https://github.com/salsa-rs/salsa/blob/2ffe4a78a824acb8c73e77497e4c2c469fcbed37/components/salsa-2022/src/function/maybe_changed_after.rs#L145\"\u003edeep\nverify\u003c/a\u003e，检查这个 query 的所有 dependency 在 \u003ccode\u003everified_at\u003c/code\u003e 之后有没有改变。（我们在 \u003ca href=\"./07_salsa_dependency.md\"\u003e这篇文章\u003c/a\u003e 讨论过 query 的 dependency）。对于\n\u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 来说，一个 dependency 就是 \u003ccode\u003etracked.field(db)\u003c/code\u003e，显然它的 \u003ccode\u003everified_at\u003c/code\u003e 小于 \u003ccode\u003ecurrent_revision\u003c/code\u003e，前面已经提到\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e对于 tracked struct 的 fields，一旦发现它 outdated，就应该 panic。如果保存的旧\n值的 \u003ccode\u003everified_at\u003c/code\u003e 小于 \u003ccode\u003eruntime.current_revision\u003c/code\u003e，我们就说这个旧值\noutdated。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eIs it really outdated?\u003c/h2\u003e\n\u003cp\u003e上一节中 \u003ccode\u003etracked.field(db)\u003c/code\u003e 其实是可用的，我们单纯用它的 \u003ccode\u003everified_at\u003c/code\u003e 做比较是有漏洞的。这个场景的特殊之处在于 \u003ccode\u003etracked.field(db)\u003c/code\u003e 既是 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e这个 query 的 input，也是其 output。\u003ccode\u003etracked.field(db)\u003c/code\u003e 是在\n\u003ccode\u003eMyTracked::new\u003c/code\u003e 中被创建的，所以是这个 query 的 output。所以，我们能不能加上一条限制：如果某个 dependency/input 同样也是该 query 的 output，我们就认为这个\ndependency/input 是有效的。\u003c/p\u003e\n\u003cp\u003e很遗憾，这仍然有漏洞，看下面这个例子。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(db: \u0026#x26;Db, input: MyInput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003etracked\u003c/span\u003e = MyTracked::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(db, input.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn_extra\u003c/span\u003e(tracked)\n}\n\n\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn_extra\u003c/span\u003e(db: \u0026#x26;Db, tracked: MyTracked) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n    tracked.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db)\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emain\u003c/span\u003e() {\n    ...\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003einput\u003c/span\u003e = MyInput::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(\u0026#x26;db, \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e);\n    _ = \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input);\n\n    \u003cspan class=\"hljs-comment\"\u003e// A \"synthetic write\" causes the system to act *as though* some\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// input of durability `durability` has changed. This is mostly\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// useful for profiling scenarios.\u003c/span\u003e\n    db.\u003cspan class=\"hljs-title function_ invoke__\"\u003esynthetic_write\u003c/span\u003e(salsa::Durabiliby::High);\n    _ = \u003cspan class=\"hljs-title function_ invoke__\"\u003etracked_fn\u003c/span\u003e(\u0026#x26;db, input); \u003cspan class=\"hljs-comment\"\u003e// panic\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eQuery\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eSalsa is a query based increamental computation system.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eQuery 一词经常在 Salsa 中提到，那到底什么是 query 呢？是 \u003ccode\u003etracked_fn\u003c/code\u003e 这个函数吗？我的理解是 \u003ccode\u003etracked_fn(\u0026#x26;db, input)\u003c/code\u003e 这个调用？当然\n\u003ccode\u003einput.field(db)\u003c/code\u003e，\u003ccode\u003etracked.field(\u0026#x26;db)\u003c/code\u003e 都是 query。\u003c/p\u003e\n\u003cp\u003e个人认为在 Salsa 代码中，\u003ccode\u003eDatabaseKeyIndex\u003c/code\u003e、\u003ccode\u003eDependencyIndex\u003c/code\u003e 和 \u003ccode\u003eMemo\u003c/code\u003e 都对应一个 query。\u003c/p\u003e\n\u003ch2\u003eInput \u0026#x26; Output\u003c/h2\u003e\n\u003cp\u003e这里所说的 input 不是 \u003ccode\u003esalsa::input\u003c/code\u003e，Input 和 output 都是对 query 而言的。Input\n就是这个 query 依赖的其他 query，我们在\u003ca href=\"./07_salsa_dependency.md\"\u003e这篇文章\u003c/a\u003e中讨论过。Query 的 output 有 3 种：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003etracked strcuts created\u003c/li\u003e\n\u003cli\u003einvacations of specify\u003c/li\u003e\n\u003cli\u003eaccumulators pushed to\u003c/li\u003e\n\u003c/ul\u003e","title":"(WIP) Salsa: Is the tracked struct valid?","date":"2022-09-26"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"09_salsa_outdated_tracked_struct"},"buildId":"KKVTGzyKFvj8chyCXvLLW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>