<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>Salsa: tracked methods</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/dba152634a942a1a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dba152634a942a1a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/69a316e8a13b4830.css" as="style"/><link rel="stylesheet" href="/_next/static/css/69a316e8a13b4830.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-e70c6273bfe3f237.js" defer=""></script><script src="/_next/static/chunks/main-d719a31ca00eb19c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-fcb060ba8fa2b368.js" defer=""></script><script src="/_next/static/chunks/640-1a3a0dc0790efd2e.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-03d1a37039c741de.js" defer=""></script><script src="/_next/static/COl1UwVvy-Dt4uS3DB-Ph/_buildManifest.js" defer=""></script><script src="/_next/static/COl1UwVvy-Dt4uS3DB-Ph/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><main><article><h1 class="utils_headingXl__u25Y2">Salsa: tracked methods</h1><div class="utils_lightText__eUzGY"><time dateTime="2022-09-04">September 4, 2022</time></div><div><p>PR <a href="https://github.com/salsa-rs/salsa/pull/392">392</a> supports tracked methods, I reviewed it and thought there were some notes to make, I tried to making it an RFC, although the pr was not created by me.</p>
<h2>Metadata</h2>
<ul>
<li>introduced in: <a href="https://github.com/salsa-rs/salsa/pull/392">https://github.com/salsa-rs/salsa/pull/392</a></li>
</ul>
<h2>Summary</h2>
<p>Support tracked methods</p>
<h2>Motivation</h2>
<p>In the Salsa 2022 system, tracked functions are almost always defined on some kind of salsa struct, it would be nice if we support tracked methods.</p>
<h2>User's guide</h2>
<p>Impl blocks with <code>#[salsa::tracked]</code> and then create tracked methods by marking individual methods with <code>#[salsa::tracked]</code>. We will get an error if we annotate a method with <code>#[salsa::tracked]</code> but forget to mark the impl block.</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::jar(db = Db)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Jar</span>(MyInput, MyInput_tracked_fn)


<span class="hljs-meta">#[salsa::input]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyInput</span> {
    field: <span class="hljs-type">u32</span>
}

<span class="hljs-meta">#[salsa::tracked(jar = Jar)]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">MyInput</span> {
    <span class="hljs-meta">#[salsa::tracked]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(<span class="hljs-keyword">self</span>, db: &#x26;<span class="hljs-keyword">dyn</span> Db) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">2</span>
    }
}
</code></pre>
<p>We also support trait impls.</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::jar(db = Db)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Jar</span>(MyInput, MyInput_TrackedTrait_tracked_trait_fn)

<span class="hljs-keyword">trait</span> <span class="hljs-title class_">TrackedTrait</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_trait_fn</span>(<span class="hljs-keyword">self</span>, db: &#x26;<span class="hljs-keyword">dyn</span> Db) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span>;
}

<span class="hljs-meta">#[salsa::tracked(jar = Jar)]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">TrackedTrait</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyInput</span> {
    <span class="hljs-meta">#[salsa::tracked]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_trait_fn</span>(<span class="hljs-keyword">self</span>, db: &#x26;<span class="hljs-keyword">dyn</span> Db) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">4</span>
    }
}
</code></pre>
<h2>Reference Guide</h2>
<p>For</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked(jar = Jar)]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">MyInput</span> {
    <span class="hljs-meta">#[salsa::tracked]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(<span class="hljs-keyword">self</span>, db: &#x26;<span class="hljs-keyword">dyn</span> Db) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">2</span>
    }
}
</code></pre>
<p>We treat it as</p>
<pre><code class="hljs language-rust"><span class="hljs-meta">#[salsa::tracked(jar = Jar)]</span>
<span class="hljs-title function_ invoke__">MyInput_tracked_fn</span>(db: &#x26;<span class="hljs-keyword">dyn</span> Db, __salsa_self: MyINput) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
    __salsa_self.<span class="hljs-title function_ invoke__">field</span>(db) * <span class="hljs-number">2</span>
}
</code></pre>
<p>So what we generate is the code generated for the tracked function <code>MyInput_tracked_fn</code> and the impl block looks like</p>
<pre><code class="hljs language-rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">MyInput</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">tracked_fn</span>(<span class="hljs-keyword">self</span>, db: &#x26;<span class="hljs-keyword">dyn</span> Db) <span class="hljs-punctuation">-></span> <span class="hljs-type">u32</span> {
        <span class="hljs-built_in">Clone</span>::<span class="hljs-title function_ invoke__">clone</span>(MyInput_tracked_fn::<span class="hljs-title function_ invoke__">get</span>(db, <span class="hljs-keyword">self</span>))
    }
}
</code></pre>
<p><strong>How to raise an error if we annotate a method with <code>#[salsa::tracked]</code> but forget to mark the impl block?</strong></p>
<p>If we forget to mark the impl block, the tracked methods with attributes <code>#[salsa::tracked]</code> will be treated as tracked functions, so we just check if the tracked function has <code>self</code> argument, and if so, we can be sure we forget to mark the impl block.</p>
<p><a href="https://github.com/salsa-rs/salsa/blob/bac4c668cfb20ad2971e244d6fe5337c651f0f17/components/salsa-2022-macros/src/tracked_fn.rs#L21-L26">related code</a></p>
<pre><code class="hljs language-rust"><span class="hljs-comment">// salsa-2022-macros::tracked_fn::tracked_fn</span>

<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"></span><span class="hljs-variable">syn</span>::FnArg::<span class="hljs-title function_ invoke__">Receiver</span>(receiver) = &#x26;item_fn.sig.inputs[<span class="hljs-number">0</span>] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(syn::Error::<span class="hljs-title function_ invoke__">new</span>(
        receiver.<span class="hljs-title function_ invoke__">span</span>(),
        <span class="hljs-string">"#[salsa::tracked] must also be applied to the impl block for tracked methods"</span>,
    ));
}
</code></pre></div></article></main><div class="layout_backToHome__9sjx_"><a href="/">‚Üê Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"08_salsa_tracked_method","contentHtml":"\u003cp\u003ePR \u003ca href=\"https://github.com/salsa-rs/salsa/pull/392\"\u003e392\u003c/a\u003e supports tracked methods, I reviewed it and thought there were some notes to make, I tried to making it an RFC, although the pr was not created by me.\u003c/p\u003e\n\u003ch2\u003eMetadata\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eintroduced in: \u003ca href=\"https://github.com/salsa-rs/salsa/pull/392\"\u003ehttps://github.com/salsa-rs/salsa/pull/392\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eSummary\u003c/h2\u003e\n\u003cp\u003eSupport tracked methods\u003c/p\u003e\n\u003ch2\u003eMotivation\u003c/h2\u003e\n\u003cp\u003eIn the Salsa 2022 system, tracked functions are almost always defined on some kind of salsa struct, it would be nice if we support tracked methods.\u003c/p\u003e\n\u003ch2\u003eUser's guide\u003c/h2\u003e\n\u003cp\u003eImpl blocks with \u003ccode\u003e#[salsa::tracked]\u003c/code\u003e and then create tracked methods by marking individual methods with \u003ccode\u003e#[salsa::tracked]\u003c/code\u003e. We will get an error if we annotate a method with \u003ccode\u003e#[salsa::tracked]\u003c/code\u003e but forget to mark the impl block.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::jar(db = Db)]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eJar\u003c/span\u003e(MyInput, MyInput_tracked_fn)\n\n\n\u003cspan class=\"hljs-meta\"\u003e#[salsa::input]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyInput\u003c/span\u003e {\n    field: \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked(jar = Jar)]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimpl\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyInput\u003c/span\u003e {\n    \u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e, db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe also support trait impls.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::jar(db = Db)]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eJar\u003c/span\u003e(MyInput, MyInput_TrackedTrait_tracked_trait_fn)\n\n\u003cspan class=\"hljs-keyword\"\u003etrait\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTrackedTrait\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_trait_fn\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e, db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked(jar = Jar)]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimpl\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eTrackedTrait\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyInput\u003c/span\u003e {\n    \u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_trait_fn\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e, db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eReference Guide\u003c/h2\u003e\n\u003cp\u003eFor\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked(jar = Jar)]\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimpl\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyInput\u003c/span\u003e {\n    \u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked]\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e, db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe treat it as\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-meta\"\u003e#[salsa::tracked(jar = Jar)]\u003c/span\u003e\n\u003cspan class=\"hljs-title function_ invoke__\"\u003eMyInput_tracked_fn\u003c/span\u003e(db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db, __salsa_self: MyINput) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n    __salsa_self.\u003cspan class=\"hljs-title function_ invoke__\"\u003efield\u003c/span\u003e(db) * \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSo what we generate is the code generated for the tracked function \u003ccode\u003eMyInput_tracked_fn\u003c/code\u003e and the impl block looks like\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimpl\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMyInput\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003etracked_fn\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e, db: \u0026#x26;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e Db) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eu32\u003c/span\u003e {\n        \u003cspan class=\"hljs-built_in\"\u003eClone\u003c/span\u003e::\u003cspan class=\"hljs-title function_ invoke__\"\u003eclone\u003c/span\u003e(MyInput_tracked_fn::\u003cspan class=\"hljs-title function_ invoke__\"\u003eget\u003c/span\u003e(db, \u003cspan class=\"hljs-keyword\"\u003eself\u003c/span\u003e))\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eHow to raise an error if we annotate a method with \u003ccode\u003e#[salsa::tracked]\u003c/code\u003e but forget to mark the impl block?\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eIf we forget to mark the impl block, the tracked methods with attributes \u003ccode\u003e#[salsa::tracked]\u003c/code\u003e will be treated as tracked functions, so we just check if the tracked function has \u003ccode\u003eself\u003c/code\u003e argument, and if so, we can be sure we forget to mark the impl block.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/salsa-rs/salsa/blob/bac4c668cfb20ad2971e244d6fe5337c651f0f17/components/salsa-2022-macros/src/tracked_fn.rs#L21-L26\"\u003erelated code\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-comment\"\u003e// salsa-2022-macros::tracked_fn::tracked_fn\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003e\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003esyn\u003c/span\u003e::FnArg::\u003cspan class=\"hljs-title function_ invoke__\"\u003eReceiver\u003c/span\u003e(receiver) = \u0026#x26;item_fn.sig.inputs[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e] {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_ invoke__\"\u003eErr\u003c/span\u003e(syn::Error::\u003cspan class=\"hljs-title function_ invoke__\"\u003enew\u003c/span\u003e(\n        receiver.\u003cspan class=\"hljs-title function_ invoke__\"\u003espan\u003c/span\u003e(),\n        \u003cspan class=\"hljs-string\"\u003e\"#[salsa::tracked] must also be applied to the impl block for tracked methods\"\u003c/span\u003e,\n    ));\n}\n\u003c/code\u003e\u003c/pre\u003e","title":"Salsa: tracked methods","date":"2022-09-04"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"08_salsa_tracked_method"},"buildId":"COl1UwVvy-Dt4uS3DB-Ph","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>