<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/github.min.css"/><title>anyhow vs error_stack: 从用户的角度来看错误处理</title><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/352a7f6477311b3a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/352a7f6477311b3a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-6cbe6e332df95288.js" defer=""></script><script src="/_next/static/chunks/main-26f9f36b33181737.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2d6bf7b3192a8752.js" defer=""></script><script src="/_next/static/chunks/73-96e6cbd54826b874.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4b57e02c440700a5.js" defer=""></script><script src="/_next/static/EEU_erGoU_JDwBtAMKr2I/_buildManifest.js" defer=""></script><script src="/_next/static/EEU_erGoU_JDwBtAMKr2I/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="max-w-4xl px-4 mt-12 mb-24 mx-auto"><main><article><h1 class="text-3xl font-medium my-4 border-b-0">anyhow vs error_stack: 从用户的角度来看错误处理</h1><div class="text-gray-500 mb-8 pb-2 border-b-2 border-solid border-slate-300"><time dateTime="2023-06-19">June 19, 2023</time></div><div><svg aria-roledescription="flowchart-v2" role="graphics-document document" viewBox="-8 -8 118.234375 215" style="max-width: 118.234375px;" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-0"><style>#mermaid-0{font-family:arial,sans-serif;font-size:16px;fill:#333;}#mermaid-0 .error-icon{fill:#552222;}#mermaid-0 .error-text{fill:#552222;stroke:#552222;}#mermaid-0 .edge-thickness-normal{stroke-width:2px;}#mermaid-0 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-0 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-0 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-0 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-0 .marker{fill:#333333;stroke:#333333;}#mermaid-0 .marker.cross{stroke:#333333;}#mermaid-0 svg{font-family:arial,sans-serif;font-size:16px;}#mermaid-0 .label{font-family:arial,sans-serif;color:#333;}#mermaid-0 .cluster-label text{fill:#333;}#mermaid-0 .cluster-label span,#mermaid-0 p{color:#333;}#mermaid-0 .label text,#mermaid-0 span,#mermaid-0 p{fill:#333;color:#333;}#mermaid-0 .node rect,#mermaid-0 .node circle,#mermaid-0 .node ellipse,#mermaid-0 .node polygon,#mermaid-0 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-0 .flowchart-label text{text-anchor:middle;}#mermaid-0 .node .label{text-align:center;}#mermaid-0 .node.clickable{cursor:pointer;}#mermaid-0 .arrowheadPath{fill:#333333;}#mermaid-0 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-0 .flowchart-link{stroke:#333333;fill:none;}#mermaid-0 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-0 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-0 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-0 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-0 .cluster text{fill:#333;}#mermaid-0 .cluster span,#mermaid-0 p{color:#333;}#mermaid-0 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-0 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-0 :root{--mermaid-font-family:arial,sans-serif;}</style><g><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="10" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-pointEnd"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker><marker orient="auto" markerHeight="12" markerWidth="12" markerUnits="userSpaceOnUse" refY="5" refX="0" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-pointStart"><path style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="11" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-circleEnd"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5" refX="-1" viewBox="0 0 10 10" class="marker flowchart" id="flowchart-circleStart"><circle style="stroke-width: 1; stroke-dasharray: 1, 0;" class="arrowMarkerPath" r="5" cy="5" cx="5"></circle></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="12" viewBox="0 0 11 11" class="marker cross flowchart" id="flowchart-crossEnd"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><marker orient="auto" markerHeight="11" markerWidth="11" markerUnits="userSpaceOnUse" refY="5.2" refX="-1" viewBox="0 0 11 11" class="marker cross flowchart" id="flowchart-crossStart"><path style="stroke-width: 2; stroke-dasharray: 1, 0;" class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9"></path></marker><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-B" id="L-A-B-0" d="M38.05859375,30.496612952889254L33.854817708333336,35.08051079407438C29.651041666666668,39.6644086352595,21.243489583333332,48.83220431762975,17.039713541666668,57.582768825481544C12.8359375,66.33333333333333,12.8359375,74.66666666666667,12.8359375,78.83333333333333L12.8359375,83"></path><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-C" id="L-A-C-0" d="M63.73046875,30.496612952889254L67.93424479166667,35.08051079407438C72.13802083333333,39.6644086352595,80.54557291666667,48.83220431762975,84.74934895833333,57.582768825481544C88.953125,66.33333333333333,88.953125,74.66666666666667,88.953125,78.83333333333333L88.953125,83"></path><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-D" id="L-B-D-0" d="M12.8359375,116L12.8359375,120.16666666666667C12.8359375,124.33333333333333,12.8359375,132.66666666666666,16.965494791666668,141.3363012761299C21.095052083333332,150.00593588559306,29.354166666666668,159.01187177118615,33.483723958333336,163.5148397139827L37.61328125,168.0178076567792"></path><path marker-end="url(#flowchart-pointEnd)" style="fill:none;" class="edge-thickness-normal edge-pattern-solid flowchart-link LS-C LE-D" id="L-C-D-0" d="M88.953125,116L88.953125,120.16666666666667C88.953125,124.33333333333333,88.953125,132.66666666666666,84.82356770833333,141.3363012761299C80.69401041666667,150.00593588559306,72.43489583333333,159.01187177118615,68.30533854166667,163.5148397139827L64.17578125,168.0178076567792"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(50.89453125, 16.5)" id="flowchart-A-16" class="node default default flowchart-label"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-5.3359375, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="10.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">A</span></div></foreignObject></g></g><g transform="translate(12.8359375, 99.5)" id="flowchart-B-17" class="node default default flowchart-label"><rect height="33" width="25.671875" y="-16.5" x="-12.8359375" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-5.3359375, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="10.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">B</span></div></foreignObject></g></g><g transform="translate(88.953125, 99.5)" id="flowchart-C-19" class="node default default flowchart-label"><rect height="33" width="26.5625" y="-16.5" x="-13.28125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-5.78125, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="11.5625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">C</span></div></foreignObject></g></g><g transform="translate(50.89453125, 182.5)" id="flowchart-D-21" class="node default default flowchart-label"><rect height="33" width="26.5625" y="-16.5" x="-13.28125" ry="0" rx="0" style="" class="basic label-container"></rect><g transform="translate(-5.78125, -9)" style="" class="label"><rect></rect><foreignObject height="18" width="11.5625"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">D</span></div></foreignObject></g></g></g></g></g></svg>
<p>本文围绕一个例子，以用户的角度来讨论 <a href="https://docs.rs/anyhow/latest/anyhow/">anyhow</a>, <a href="https://docs.rs/error-stack/latest/error_stack/">error_stack</a> 解决了什么样的需求，能否给错误处理带来便利。</p>
<blockquote>
<p>本文的例子改编自 <a href="https://github.com/hashintel/hash/blob/main/libs/error-stack/README.md">error_stack README.md</a></p>
</blockquote>
<h2><code>Box&#x3C;dyn std::error::Error></code></h2>
<p>在讨论 anyhow 和 error_stack 之前，我们先来看看我们的 baseline：用 <code>Box&#x3C;dyn std::error::Error></code> 来处理错误。</p>
<p>这是最粗暴的错误处理方式，所有的错误都被转换成了 <code>Box&#x3C;dyn std::error::Error></code>。</p>
<p>看到下面这么大一段代码，你肯定很头疼，不过不用担心，我们并不需要阅读这段代码，你可以把自己想象成这段代码的维护者，刚接手这段代码，现在遇到一个报错，需要定位到错误的原因。你需要从报错信息入手，思考如何定位到错误的原因。</p>
<pre><code class="hljs language-rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">BoxDynError</span> = <span class="hljs-type">Box</span>&#x3C;<span class="hljs-keyword">dyn</span> std::error::Error>;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">parse_experiment</span>(description: &#x26;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-></span> <span class="hljs-type">Result</span>&#x3C;(<span class="hljs-type">u64</span>, <span class="hljs-type">u64</span>), BoxDynError> {
    <span class="hljs-keyword">let</span> <span class="hljs-variable">value</span> = description.<span class="hljs-title function_ invoke__">parse</span>()?;

    <span class="hljs-title function_ invoke__">Ok</span>((value, <span class="hljs-number">2</span> * value))
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">start_experiments</span>(
    experiment_ids: &#x26;[<span class="hljs-type">usize</span>],
    experiment_descriptions: &#x26;[&#x26;<span class="hljs-type">str</span>],
) <span class="hljs-punctuation">-></span> <span class="hljs-type">Result</span>&#x3C;<span class="hljs-type">Vec</span>&#x3C;<span class="hljs-type">u64</span>>, BoxDynError> {
    <span class="hljs-keyword">let</span> <span class="hljs-variable">experiments</span> = experiment_ids
        .<span class="hljs-title function_ invoke__">iter</span>()
        .<span class="hljs-title function_ invoke__">map</span>(|exp_id| {
            <span class="hljs-keyword">let</span> <span class="hljs-variable">description</span> = <span class="hljs-keyword">match</span> experiment_descriptions.<span class="hljs-title function_ invoke__">get</span>(*exp_id) {
                <span class="hljs-title function_ invoke__">Some</span>(desc) => desc,
                <span class="hljs-literal">None</span> => <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"experiment {exp_id} has no valid description"</span>).<span class="hljs-title function_ invoke__">into</span>()),
            };
            <span class="hljs-keyword">let</span> <span class="hljs-variable">experiment</span> = <span class="hljs-title function_ invoke__">parse_experiment</span>(description)?;

            <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">move</span> || experiment.<span class="hljs-number">0</span> * experiment.<span class="hljs-number">1</span>)
        })
        .collect::&#x3C;<span class="hljs-type">Result</span>&#x3C;<span class="hljs-type">Vec</span>&#x3C;_>, BoxDynError>>()?;

    <span class="hljs-title function_ invoke__">Ok</span>(experiments.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|experiment| <span class="hljs-title function_ invoke__">experiment</span>()).<span class="hljs-title function_ invoke__">collect</span>())
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-></span> <span class="hljs-type">Result</span>&#x3C;(), BoxDynError> {
    <span class="hljs-keyword">let</span> <span class="hljs-variable">experiment_ids</span> = &#x26;[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>];
    <span class="hljs-keyword">let</span> <span class="hljs-variable">experiment_descriptions</span> = &#x26;[<span class="hljs-string">"10"</span>, <span class="hljs-string">"20"</span>, <span class="hljs-string">"3o"</span>];
    <span class="hljs-title function_ invoke__">start_experiments</span>(experiment_ids, experiment_descriptions)?;

    <span class="hljs-title function_ invoke__">Ok</span>(())
}

</code></pre>
<p>运行这段代码，会得到如下的错误信息：</p>
<pre><code class="language-text">Error: ParseIntError { kind: InvalidDigit }
</code></pre>
<p>看到这段错误信息，很难快速定位到错误的原因。我需要阅读代码，才能知道错误发生在哪里。如果要定位到错误的原因，我希望得到什么样的信息呢？
最好有 backtrace, 帮助定位到错误发生的位置，还希望能够得到错误的上下文信息，比如和报错相关的变量的值。接下来我们来看看 anyhow 和 error_stack 能否帮助我们更快速的定位到错误的原因。</p>
<h2>anyhow</h2>
<p>anyhow 的使用方式和 <code>Box&#x3C;dyn std::error::Error></code> 非常类似，我们只需要将 <code>Box&#x3C;dyn std::error::Error></code> 替换成 <code>anyhow::Error</code> 即可。</p>
<pre><code class="hljs language-diff"><span class="hljs-addition">+ use anyhow::Context;</span>

<span class="hljs-deletion">- fn parse_experiment(description: &#x26;str) -> Result&#x3C;(u64, u64), BoxDynError> {</span>
<span class="hljs-addition">+ fn parse_experiment(description: &#x26;str) -> Result&#x3C;(u64, u64), anyhow::Error> {</span>
    let value = description
        .parse()
<span class="hljs-addition">+        .context(format!("{description:?} could not be parsed as experiment"))?;</span>

    Ok((value, 2 * value))
}

fn start_experiments(
    experiment_ids: &#x26;[usize],
    experiment_descriptions: &#x26;[&#x26;str],
) -> Result&#x3C;Vec&#x3C;u64>, anyhow::Error> {
    let experiments = experiment_ids
        .iter()
        .map(|exp_id| {
            let description = experiment_descriptions
                .get(*exp_id)
<span class="hljs-addition">+                .context(format!("experiment {exp_id} has no valid description"))?;</span>
            let experiment = parse_experiment(description)
<span class="hljs-addition">+                .context(format!("experiment {exp_id} could not be parsed"))?;</span>

            Ok(move || experiment.0 * experiment.1)
        })
        .collect::&#x3C;Result&#x3C;Vec&#x3C;_>, anyhow::Error>>()
<span class="hljs-addition">+        .context(format!("unable to set up experiments"))?;</span>

    Ok(experiments.iter().map(|experiment| experiment()).collect())
}

fn main() -> Result&#x3C;(), anyhow::Error> {
    let experiment_ids = &#x26;[0, 2];
    let experiment_descriptions = &#x26;["10", "20", "3o"];
    start_experiments(experiment_ids, experiment_descriptions)?;

    Ok(())
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：上述 diff 中并没有展示所有的改动，比如有些 <code>Box&#x3C;dyn std::error::Error></code> 的改动，以及 <code>?</code> 的改动。</p>
</blockquote>
<p>除了将 <code>Box&#x3C;dyn std::error::Error></code> 替换成 <code>anyhow::Error</code> 之外，我们还使用了 <code>anyhow::Context</code> 来为错误添加上下文信息。</p>
<p>运行这段代码，会得到如下的错误信息：</p>
<pre><code class="language-text">Error: unable to set up experiments

Caused by:
    0: experiment 2 could not be parsed
    1: "3o" could not be parsed as experiment
    2: invalid digit found in string
</code></pre>
<p>这里的错误信息多是通过 <code>context</code> 添加的上下文信息，可以看到，我们已经能够快速定位到错误的原因了： <code>3o</code> 不能被解析成数字。</p>
<p>但我们现在不能快速定位到错误发生的具体位置，这需要 backtrace 信息。anyhow 能提供 backtrace 吗？当然可以，我们只需要在运行程序的时候，设置环境变量 <code>RUST_BACKTRACE=1</code> 即可。</p>
<pre><code class="language-text">Error: unable to set up experiments

Caused by:
    0: experiment 2 could not be parsed
    1: "3o" could not be parsed as experiment
    2: invalid digit found in string

Stack backtrace:
   0: anyhow::context::&#x3C;impl anyhow::Context&#x3C;T,E> for core::result::Result&#x3C;T,E>>::context
             at /root/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/anyhow-1.0.71/src/context.rs:54:31
   1: anyhow::parse_experiment
             at ./src/bin/anyhow.rs:4:17
   2: anyhow::start_experiments::{{closure}}
             at ./src/bin/anyhow.rs:21:30
   3: core::iter::adapters::map::map_try_fold::{{closure}}
             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/adapters/map.rs:91:28
   4: core::iter::traits::iterator::Iterator::try_fold
             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/traits/iterator.rs:2304:21
   5: &#x3C;core::iter::adapters::map::Map&#x3C;I,F> as core::iter::traits::iterator::Iterator>::try_fold
             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/adapters/map.rs:117:9
   6: &#x3C;core::iter::adapters::GenericShunt&#x3C;I,R> as core::iter::traits::iterator::Iterator>::try_fold
             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/adapters/mod.rs:195:9
...
</code></pre>
<blockquote>
<p><strong>注意</strong>：如果用的是 stable 版本的 rust，需要对 anyhow 添加 "backtrace" feature，才能使用 backtrace 功能。</p>
</blockquote>
<p>虽然 anyhow 能够提供 backtrace 信息，但是这个 backtrace 信息并不是很友好，包含了太多冗余信息（比如 rust core lib 的 backtrace）。这一点，我们可以通过 error_stack 来改进。</p>
<h2>error_stack</h2>
<pre><code class="hljs language-diff"><span class="hljs-addition">+ use std::fmt;</span>

<span class="hljs-addition">+ use error_stack::{Context, IntoReport, Report, Result, ResultExt};</span>

<span class="hljs-addition">+ #[derive(Debug)]</span>
<span class="hljs-addition">+ struct ParseExperimentError;</span>

<span class="hljs-addition">+ impl fmt::Display for ParseExperimentError {</span>
<span class="hljs-addition">+     fn fmt(&#x26;self, fmt: &#x26;mut fmt::Formatter&#x3C;'_>) -> fmt::Result {</span>
<span class="hljs-addition">+         fmt.write_str("invalid experiment description")</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+ }</span>

<span class="hljs-addition">+ impl Context for ParseExperimentError {}</span>

<span class="hljs-deletion">- fn parse_experiment(description: &#x26;str) -> Result&#x3C;(u64, u64), BoxDynError> {</span>
<span class="hljs-addition">+ fn parse_experiment(description: &#x26;str) -> Result&#x3C;(u64, u64), ParseExperimentError> {</span>
    let value = description
        .parse()
<span class="hljs-addition">+         .into_report()</span>
<span class="hljs-addition">+         .attach_printable_lazy(|| format!("{description:?} could not be parsed as experiment"))</span>
<span class="hljs-addition">+         .change_context(ParseExperimentError)?;</span>

    Ok((value, 2 * value))
}

<span class="hljs-addition">+ #[derive(Debug)]</span>
<span class="hljs-addition">+ struct ExperimentError;</span>

<span class="hljs-addition">+ impl fmt::Display for ExperimentError {</span>
<span class="hljs-addition">+     fn fmt(&#x26;self, fmt: &#x26;mut fmt::Formatter&#x3C;'_>) -> fmt::Result {</span>
<span class="hljs-addition">+         fmt.write_str("experiment error: could not run experiment")</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+ }</span>

<span class="hljs-addition">+ impl Context for ExperimentError {}</span>

fn start_experiments(
    experiment_ids: &#x26;[usize],
    experiment_descriptions: &#x26;[&#x26;str],
) -> Result&#x3C;Vec&#x3C;u64>, ExperimentError> {
    let experiments = experiment_ids
        .iter()
        .map(|exp_id| {
            let description = experiment_descriptions.get(*exp_id).ok_or_else(|| {
<span class="hljs-addition">+                 Report::new(ExperimentError)</span>
<span class="hljs-addition">+                     .attach_printable(format!("experiment {exp_id} has no valid description"))</span>
            })?;

            let experiment = parse_experiment(description)
<span class="hljs-addition">+                 .attach_printable(format!("experiment {exp_id} could not be parsed"))</span>
<span class="hljs-addition">+                 .change_context(ExperimentError)?;</span>

            Ok(move || experiment.0 * experiment.1)
        })
        .collect::&#x3C;Result&#x3C;Vec&#x3C;_>, ExperimentError>>()
<span class="hljs-addition">+       .attach_printable("unable to set up experiments")?;</span>

    Ok(experiments.iter().map(|experiment| experiment()).collect())
}

fn main() -> Result&#x3C;(), ExperimentError> {
    let experiment_ids = &#x26;[0, 2];
    let experiment_descriptions = &#x26;["10", "20", "3o"];
    start_experiments(experiment_ids, experiment_descriptions)?;

    Ok(())
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：以上并不是严格的 diff，只是展示了主要的改动。</p>
</blockquote>
<p>运行这段代码，会得到如下的错误信息：</p>
<pre><code class="language-text">Error: experiment error: could not run experiment
├╴at src/bin/error_stack.rs:51:18
├╴unable to set up experiments
│
├─▶ invalid experiment description
│   ├╴at src/bin/error_stack.rs:21:10
│   ╰╴experiment 2 could not be parsed
│
╰─▶ invalid digit found in string
    ├╴at src/bin/error_stack.rs:19:10
    ╰╴"3o" could not be parsed as experiment
</code></pre>
<p>和 anyhow 相比，error_stack 需要我们编写更多的代码，但是 error_stack 提供的错误信息更加友好，给我们展示了每一个层级的错误信息，上下文信息以及错误发生的具体位置。</p>
<hr>
<p>总结一下，anyhow 和 error_stack 都是非常优秀的 error handling crate，都提供了友好的错误信息，可以帮助我们快速定位错误。anyhow 的优势在于它的使用非常简单，几乎不需要我们编写额外的代码。error_stack 的优势在于它的错误信息更加友好，更直观地展示了错误发生地位置，但是它的使用相对复杂一点。</p></div></article></main><div class="mt-12"><a href="/">← 返回首页</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"rust_error_handling","contentHtml":"\u003csvg aria-roledescription=\"flowchart-v2\" role=\"graphics-document document\" viewBox=\"-8 -8 118.234375 215\" style=\"max-width: 118.234375px;\" xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" id=\"mermaid-0\"\u003e\u003cstyle\u003e#mermaid-0{font-family:arial,sans-serif;font-size:16px;fill:#333;}#mermaid-0 .error-icon{fill:#552222;}#mermaid-0 .error-text{fill:#552222;stroke:#552222;}#mermaid-0 .edge-thickness-normal{stroke-width:2px;}#mermaid-0 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-0 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-0 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-0 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-0 .marker{fill:#333333;stroke:#333333;}#mermaid-0 .marker.cross{stroke:#333333;}#mermaid-0 svg{font-family:arial,sans-serif;font-size:16px;}#mermaid-0 .label{font-family:arial,sans-serif;color:#333;}#mermaid-0 .cluster-label text{fill:#333;}#mermaid-0 .cluster-label span,#mermaid-0 p{color:#333;}#mermaid-0 .label text,#mermaid-0 span,#mermaid-0 p{fill:#333;color:#333;}#mermaid-0 .node rect,#mermaid-0 .node circle,#mermaid-0 .node ellipse,#mermaid-0 .node polygon,#mermaid-0 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-0 .flowchart-label text{text-anchor:middle;}#mermaid-0 .node .label{text-align:center;}#mermaid-0 .node.clickable{cursor:pointer;}#mermaid-0 .arrowheadPath{fill:#333333;}#mermaid-0 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-0 .flowchart-link{stroke:#333333;fill:none;}#mermaid-0 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-0 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-0 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-0 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-0 .cluster text{fill:#333;}#mermaid-0 .cluster span,#mermaid-0 p{color:#333;}#mermaid-0 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-0 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-0 :root{--mermaid-font-family:arial,sans-serif;}\u003c/style\u003e\u003cg\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"10\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointEnd\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 0 L 10 5 L 0 10 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"12\" markerWidth=\"12\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"0\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-pointStart\"\u003e\u003cpath style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 0 5 L 10 10 L 10 0 z\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"11\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleEnd\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5\" refX=\"-1\" viewBox=\"0 0 10 10\" class=\"marker flowchart\" id=\"flowchart-circleStart\"\u003e\u003ccircle style=\"stroke-width: 1; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" r=\"5\" cy=\"5\" cx=\"5\"\u003e\u003c/circle\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"12\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossEnd\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cmarker orient=\"auto\" markerHeight=\"11\" markerWidth=\"11\" markerUnits=\"userSpaceOnUse\" refY=\"5.2\" refX=\"-1\" viewBox=\"0 0 11 11\" class=\"marker cross flowchart\" id=\"flowchart-crossStart\"\u003e\u003cpath style=\"stroke-width: 2; stroke-dasharray: 1, 0;\" class=\"arrowMarkerPath\" d=\"M 1,1 l 9,9 M 10,1 l -9,9\"\u003e\u003c/path\u003e\u003c/marker\u003e\u003cg class=\"root\"\u003e\u003cg class=\"clusters\"\u003e\u003c/g\u003e\u003cg class=\"edgePaths\"\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-B\" id=\"L-A-B-0\" d=\"M38.05859375,30.496612952889254L33.854817708333336,35.08051079407438C29.651041666666668,39.6644086352595,21.243489583333332,48.83220431762975,17.039713541666668,57.582768825481544C12.8359375,66.33333333333333,12.8359375,74.66666666666667,12.8359375,78.83333333333333L12.8359375,83\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-A LE-C\" id=\"L-A-C-0\" d=\"M63.73046875,30.496612952889254L67.93424479166667,35.08051079407438C72.13802083333333,39.6644086352595,80.54557291666667,48.83220431762975,84.74934895833333,57.582768825481544C88.953125,66.33333333333333,88.953125,74.66666666666667,88.953125,78.83333333333333L88.953125,83\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-B LE-D\" id=\"L-B-D-0\" d=\"M12.8359375,116L12.8359375,120.16666666666667C12.8359375,124.33333333333333,12.8359375,132.66666666666666,16.965494791666668,141.3363012761299C21.095052083333332,150.00593588559306,29.354166666666668,159.01187177118615,33.483723958333336,163.5148397139827L37.61328125,168.0178076567792\"\u003e\u003c/path\u003e\u003cpath marker-end=\"url(#flowchart-pointEnd)\" style=\"fill:none;\" class=\"edge-thickness-normal edge-pattern-solid flowchart-link LS-C LE-D\" id=\"L-C-D-0\" d=\"M88.953125,116L88.953125,120.16666666666667C88.953125,124.33333333333333,88.953125,132.66666666666666,84.82356770833333,141.3363012761299C80.69401041666667,150.00593588559306,72.43489583333333,159.01187177118615,68.30533854166667,163.5148397139827L64.17578125,168.0178076567792\"\u003e\u003c/path\u003e\u003c/g\u003e\u003cg class=\"edgeLabels\"\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"edgeLabel\"\u003e\u003cg transform=\"translate(0, 0)\" class=\"label\"\u003e\u003cforeignObject height=\"0\" width=\"0\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"edgeLabel\"\u003e\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003cg class=\"nodes\"\u003e\u003cg transform=\"translate(50.89453125, 16.5)\" id=\"flowchart-A-16\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"25.671875\" y=\"-16.5\" x=\"-12.8359375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-5.3359375, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"10.671875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eA\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(12.8359375, 99.5)\" id=\"flowchart-B-17\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"25.671875\" y=\"-16.5\" x=\"-12.8359375\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-5.3359375, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"10.671875\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eB\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(88.953125, 99.5)\" id=\"flowchart-C-19\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"26.5625\" y=\"-16.5\" x=\"-13.28125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-5.78125, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"11.5625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eC\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003cg transform=\"translate(50.89453125, 182.5)\" id=\"flowchart-D-21\" class=\"node default default flowchart-label\"\u003e\u003crect height=\"33\" width=\"26.5625\" y=\"-16.5\" x=\"-13.28125\" ry=\"0\" rx=\"0\" style=\"\" class=\"basic label-container\"\u003e\u003c/rect\u003e\u003cg transform=\"translate(-5.78125, -9)\" style=\"\" class=\"label\"\u003e\u003crect\u003e\u003c/rect\u003e\u003cforeignObject height=\"18\" width=\"11.5625\"\u003e\u003cdiv style=\"display: inline-block; white-space: nowrap;\" xmlns=\"http://www.w3.org/1999/xhtml\"\u003e\u003cspan class=\"nodeLabel\"\u003eD\u003c/span\u003e\u003c/div\u003e\u003c/foreignObject\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/g\u003e\u003c/svg\u003e\n\u003cp\u003e本文围绕一个例子，以用户的角度来讨论 \u003ca href=\"https://docs.rs/anyhow/latest/anyhow/\"\u003eanyhow\u003c/a\u003e, \u003ca href=\"https://docs.rs/error-stack/latest/error_stack/\"\u003eerror_stack\u003c/a\u003e 解决了什么样的需求，能否给错误处理带来便利。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e本文的例子改编自 \u003ca href=\"https://github.com/hashintel/hash/blob/main/libs/error-stack/README.md\"\u003eerror_stack README.md\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003e\u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003e在讨论 anyhow 和 error_stack 之前，我们先来看看我们的 baseline：用 \u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e 来处理错误。\u003c/p\u003e\n\u003cp\u003e这是最粗暴的错误处理方式，所有的错误都被转换成了 \u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e看到下面这么大一段代码，你肯定很头疼，不过不用担心，我们并不需要阅读这段代码，你可以把自己想象成这段代码的维护者，刚接手这段代码，现在遇到一个报错，需要定位到错误的原因。你需要从报错信息入手，思考如何定位到错误的原因。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-rust\"\u003e\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBoxDynError\u003c/span\u003e = \u003cspan class=\"hljs-type\"\u003eBox\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-keyword\"\u003edyn\u003c/span\u003e std::error::Error\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eparse_experiment\u003c/span\u003e(description: \u0026#x26;\u003cspan class=\"hljs-type\"\u003estr\u003c/span\u003e) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eResult\u003c/span\u003e\u0026#x3C;(\u003cspan class=\"hljs-type\"\u003eu64\u003c/span\u003e, \u003cspan class=\"hljs-type\"\u003eu64\u003c/span\u003e), BoxDynError\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003evalue\u003c/span\u003e = description.\u003cspan class=\"hljs-title function_ invoke__\"\u003eparse\u003c/span\u003e()?;\n\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003eOk\u003c/span\u003e((value, \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e * value))\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003estart_experiments\u003c/span\u003e(\n    experiment_ids: \u0026#x26;[\u003cspan class=\"hljs-type\"\u003eusize\u003c/span\u003e],\n    experiment_descriptions: \u0026#x26;[\u0026#x26;\u003cspan class=\"hljs-type\"\u003estr\u003c/span\u003e],\n) \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eResult\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-type\"\u003eVec\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-type\"\u003eu64\u003c/span\u003e\u003e, BoxDynError\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003eexperiments\u003c/span\u003e = experiment_ids\n        .\u003cspan class=\"hljs-title function_ invoke__\"\u003eiter\u003c/span\u003e()\n        .\u003cspan class=\"hljs-title function_ invoke__\"\u003emap\u003c/span\u003e(|exp_id| {\n            \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003edescription\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003ematch\u003c/span\u003e experiment_descriptions.\u003cspan class=\"hljs-title function_ invoke__\"\u003eget\u003c/span\u003e(*exp_id) {\n                \u003cspan class=\"hljs-title function_ invoke__\"\u003eSome\u003c/span\u003e(desc) =\u003e desc,\n                \u003cspan class=\"hljs-literal\"\u003eNone\u003c/span\u003e =\u003e \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_ invoke__\"\u003eErr\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003eformat!\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"experiment {exp_id} has no valid description\"\u003c/span\u003e).\u003cspan class=\"hljs-title function_ invoke__\"\u003einto\u003c/span\u003e()),\n            };\n            \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003eexperiment\u003c/span\u003e = \u003cspan class=\"hljs-title function_ invoke__\"\u003eparse_experiment\u003c/span\u003e(description)?;\n\n            \u003cspan class=\"hljs-title function_ invoke__\"\u003eOk\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003emove\u003c/span\u003e || experiment.\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e * experiment.\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\n        })\n        .collect::\u0026#x3C;\u003cspan class=\"hljs-type\"\u003eResult\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-type\"\u003eVec\u003c/span\u003e\u0026#x3C;_\u003e, BoxDynError\u003e\u003e()?;\n\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003eOk\u003c/span\u003e(experiments.\u003cspan class=\"hljs-title function_ invoke__\"\u003eiter\u003c/span\u003e().\u003cspan class=\"hljs-title function_ invoke__\"\u003emap\u003c/span\u003e(|experiment| \u003cspan class=\"hljs-title function_ invoke__\"\u003eexperiment\u003c/span\u003e()).\u003cspan class=\"hljs-title function_ invoke__\"\u003ecollect\u003c/span\u003e())\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emain\u003c/span\u003e() \u003cspan class=\"hljs-punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eResult\u003c/span\u003e\u0026#x3C;(), BoxDynError\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003eexperiment_ids\u003c/span\u003e = \u0026#x26;[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e];\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003eexperiment_descriptions\u003c/span\u003e = \u0026#x26;[\u003cspan class=\"hljs-string\"\u003e\"10\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"20\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"3o\"\u003c/span\u003e];\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003estart_experiments\u003c/span\u003e(experiment_ids, experiment_descriptions)?;\n\n    \u003cspan class=\"hljs-title function_ invoke__\"\u003eOk\u003c/span\u003e(())\n}\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e运行这段代码，会得到如下的错误信息：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003eError: ParseIntError { kind: InvalidDigit }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e看到这段错误信息，很难快速定位到错误的原因。我需要阅读代码，才能知道错误发生在哪里。如果要定位到错误的原因，我希望得到什么样的信息呢？\n最好有 backtrace, 帮助定位到错误发生的位置，还希望能够得到错误的上下文信息，比如和报错相关的变量的值。接下来我们来看看 anyhow 和 error_stack 能否帮助我们更快速的定位到错误的原因。\u003c/p\u003e\n\u003ch2\u003eanyhow\u003c/h2\u003e\n\u003cp\u003eanyhow 的使用方式和 \u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e 非常类似，我们只需要将 \u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e 替换成 \u003ccode\u003eanyhow::Error\u003c/code\u003e 即可。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e\u003cspan class=\"hljs-addition\"\u003e+ use anyhow::Context;\u003c/span\u003e\n\n\u003cspan class=\"hljs-deletion\"\u003e- fn parse_experiment(description: \u0026#x26;str) -\u003e Result\u0026#x3C;(u64, u64), BoxDynError\u003e {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ fn parse_experiment(description: \u0026#x26;str) -\u003e Result\u0026#x3C;(u64, u64), anyhow::Error\u003e {\u003c/span\u003e\n    let value = description\n        .parse()\n\u003cspan class=\"hljs-addition\"\u003e+        .context(format!(\"{description:?} could not be parsed as experiment\"))?;\u003c/span\u003e\n\n    Ok((value, 2 * value))\n}\n\nfn start_experiments(\n    experiment_ids: \u0026#x26;[usize],\n    experiment_descriptions: \u0026#x26;[\u0026#x26;str],\n) -\u003e Result\u0026#x3C;Vec\u0026#x3C;u64\u003e, anyhow::Error\u003e {\n    let experiments = experiment_ids\n        .iter()\n        .map(|exp_id| {\n            let description = experiment_descriptions\n                .get(*exp_id)\n\u003cspan class=\"hljs-addition\"\u003e+                .context(format!(\"experiment {exp_id} has no valid description\"))?;\u003c/span\u003e\n            let experiment = parse_experiment(description)\n\u003cspan class=\"hljs-addition\"\u003e+                .context(format!(\"experiment {exp_id} could not be parsed\"))?;\u003c/span\u003e\n\n            Ok(move || experiment.0 * experiment.1)\n        })\n        .collect::\u0026#x3C;Result\u0026#x3C;Vec\u0026#x3C;_\u003e, anyhow::Error\u003e\u003e()\n\u003cspan class=\"hljs-addition\"\u003e+        .context(format!(\"unable to set up experiments\"))?;\u003c/span\u003e\n\n    Ok(experiments.iter().map(|experiment| experiment()).collect())\n}\n\nfn main() -\u003e Result\u0026#x3C;(), anyhow::Error\u003e {\n    let experiment_ids = \u0026#x26;[0, 2];\n    let experiment_descriptions = \u0026#x26;[\"10\", \"20\", \"3o\"];\n    start_experiments(experiment_ids, experiment_descriptions)?;\n\n    Ok(())\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003e注意\u003c/strong\u003e：上述 diff 中并没有展示所有的改动，比如有些 \u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e 的改动，以及 \u003ccode\u003e?\u003c/code\u003e 的改动。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e除了将 \u003ccode\u003eBox\u0026#x3C;dyn std::error::Error\u003e\u003c/code\u003e 替换成 \u003ccode\u003eanyhow::Error\u003c/code\u003e 之外，我们还使用了 \u003ccode\u003eanyhow::Context\u003c/code\u003e 来为错误添加上下文信息。\u003c/p\u003e\n\u003cp\u003e运行这段代码，会得到如下的错误信息：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003eError: unable to set up experiments\n\nCaused by:\n    0: experiment 2 could not be parsed\n    1: \"3o\" could not be parsed as experiment\n    2: invalid digit found in string\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这里的错误信息多是通过 \u003ccode\u003econtext\u003c/code\u003e 添加的上下文信息，可以看到，我们已经能够快速定位到错误的原因了： \u003ccode\u003e3o\u003c/code\u003e 不能被解析成数字。\u003c/p\u003e\n\u003cp\u003e但我们现在不能快速定位到错误发生的具体位置，这需要 backtrace 信息。anyhow 能提供 backtrace 吗？当然可以，我们只需要在运行程序的时候，设置环境变量 \u003ccode\u003eRUST_BACKTRACE=1\u003c/code\u003e 即可。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003eError: unable to set up experiments\n\nCaused by:\n    0: experiment 2 could not be parsed\n    1: \"3o\" could not be parsed as experiment\n    2: invalid digit found in string\n\nStack backtrace:\n   0: anyhow::context::\u0026#x3C;impl anyhow::Context\u0026#x3C;T,E\u003e for core::result::Result\u0026#x3C;T,E\u003e\u003e::context\n             at /root/.cargo/registry/src/rsproxy.cn-8f6827c7555bfaf8/anyhow-1.0.71/src/context.rs:54:31\n   1: anyhow::parse_experiment\n             at ./src/bin/anyhow.rs:4:17\n   2: anyhow::start_experiments::{{closure}}\n             at ./src/bin/anyhow.rs:21:30\n   3: core::iter::adapters::map::map_try_fold::{{closure}}\n             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/adapters/map.rs:91:28\n   4: core::iter::traits::iterator::Iterator::try_fold\n             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/traits/iterator.rs:2304:21\n   5: \u0026#x3C;core::iter::adapters::map::Map\u0026#x3C;I,F\u003e as core::iter::traits::iterator::Iterator\u003e::try_fold\n             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/adapters/map.rs:117:9\n   6: \u0026#x3C;core::iter::adapters::GenericShunt\u0026#x3C;I,R\u003e as core::iter::traits::iterator::Iterator\u003e::try_fold\n             at /rustc/90c541806f23a127002de5b4038be731ba1458ca/library/core/src/iter/adapters/mod.rs:195:9\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003e注意\u003c/strong\u003e：如果用的是 stable 版本的 rust，需要对 anyhow 添加 \"backtrace\" feature，才能使用 backtrace 功能。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e虽然 anyhow 能够提供 backtrace 信息，但是这个 backtrace 信息并不是很友好，包含了太多冗余信息（比如 rust core lib 的 backtrace）。这一点，我们可以通过 error_stack 来改进。\u003c/p\u003e\n\u003ch2\u003eerror_stack\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003e\u003cspan class=\"hljs-addition\"\u003e+ use std::fmt;\u003c/span\u003e\n\n\u003cspan class=\"hljs-addition\"\u003e+ use error_stack::{Context, IntoReport, Report, Result, ResultExt};\u003c/span\u003e\n\n\u003cspan class=\"hljs-addition\"\u003e+ #[derive(Debug)]\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ struct ParseExperimentError;\u003c/span\u003e\n\n\u003cspan class=\"hljs-addition\"\u003e+ impl fmt::Display for ParseExperimentError {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+     fn fmt(\u0026#x26;self, fmt: \u0026#x26;mut fmt::Formatter\u0026#x3C;'_\u003e) -\u003e fmt::Result {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+         fmt.write_str(\"invalid experiment description\")\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+     }\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ }\u003c/span\u003e\n\n\u003cspan class=\"hljs-addition\"\u003e+ impl Context for ParseExperimentError {}\u003c/span\u003e\n\n\u003cspan class=\"hljs-deletion\"\u003e- fn parse_experiment(description: \u0026#x26;str) -\u003e Result\u0026#x3C;(u64, u64), BoxDynError\u003e {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ fn parse_experiment(description: \u0026#x26;str) -\u003e Result\u0026#x3C;(u64, u64), ParseExperimentError\u003e {\u003c/span\u003e\n    let value = description\n        .parse()\n\u003cspan class=\"hljs-addition\"\u003e+         .into_report()\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+         .attach_printable_lazy(|| format!(\"{description:?} could not be parsed as experiment\"))\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+         .change_context(ParseExperimentError)?;\u003c/span\u003e\n\n    Ok((value, 2 * value))\n}\n\n\u003cspan class=\"hljs-addition\"\u003e+ #[derive(Debug)]\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ struct ExperimentError;\u003c/span\u003e\n\n\u003cspan class=\"hljs-addition\"\u003e+ impl fmt::Display for ExperimentError {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+     fn fmt(\u0026#x26;self, fmt: \u0026#x26;mut fmt::Formatter\u0026#x3C;'_\u003e) -\u003e fmt::Result {\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+         fmt.write_str(\"experiment error: could not run experiment\")\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+     }\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ }\u003c/span\u003e\n\n\u003cspan class=\"hljs-addition\"\u003e+ impl Context for ExperimentError {}\u003c/span\u003e\n\nfn start_experiments(\n    experiment_ids: \u0026#x26;[usize],\n    experiment_descriptions: \u0026#x26;[\u0026#x26;str],\n) -\u003e Result\u0026#x3C;Vec\u0026#x3C;u64\u003e, ExperimentError\u003e {\n    let experiments = experiment_ids\n        .iter()\n        .map(|exp_id| {\n            let description = experiment_descriptions.get(*exp_id).ok_or_else(|| {\n\u003cspan class=\"hljs-addition\"\u003e+                 Report::new(ExperimentError)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+                     .attach_printable(format!(\"experiment {exp_id} has no valid description\"))\u003c/span\u003e\n            })?;\n\n            let experiment = parse_experiment(description)\n\u003cspan class=\"hljs-addition\"\u003e+                 .attach_printable(format!(\"experiment {exp_id} could not be parsed\"))\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+                 .change_context(ExperimentError)?;\u003c/span\u003e\n\n            Ok(move || experiment.0 * experiment.1)\n        })\n        .collect::\u0026#x3C;Result\u0026#x3C;Vec\u0026#x3C;_\u003e, ExperimentError\u003e\u003e()\n\u003cspan class=\"hljs-addition\"\u003e+       .attach_printable(\"unable to set up experiments\")?;\u003c/span\u003e\n\n    Ok(experiments.iter().map(|experiment| experiment()).collect())\n}\n\nfn main() -\u003e Result\u0026#x3C;(), ExperimentError\u003e {\n    let experiment_ids = \u0026#x26;[0, 2];\n    let experiment_descriptions = \u0026#x26;[\"10\", \"20\", \"3o\"];\n    start_experiments(experiment_ids, experiment_descriptions)?;\n\n    Ok(())\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003e注意\u003c/strong\u003e：以上并不是严格的 diff，只是展示了主要的改动。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e运行这段代码，会得到如下的错误信息：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003eError: experiment error: could not run experiment\n├╴at src/bin/error_stack.rs:51:18\n├╴unable to set up experiments\n│\n├─▶ invalid experiment description\n│   ├╴at src/bin/error_stack.rs:21:10\n│   ╰╴experiment 2 could not be parsed\n│\n╰─▶ invalid digit found in string\n    ├╴at src/bin/error_stack.rs:19:10\n    ╰╴\"3o\" could not be parsed as experiment\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e和 anyhow 相比，error_stack 需要我们编写更多的代码，但是 error_stack 提供的错误信息更加友好，给我们展示了每一个层级的错误信息，上下文信息以及错误发生的具体位置。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e总结一下，anyhow 和 error_stack 都是非常优秀的 error handling crate，都提供了友好的错误信息，可以帮助我们快速定位错误。anyhow 的优势在于它的使用非常简单，几乎不需要我们编写额外的代码。error_stack 的优势在于它的错误信息更加友好，更直观地展示了错误发生地位置，但是它的使用相对复杂一点。\u003c/p\u003e","title":"anyhow vs error_stack: 从用户的角度来看错误处理","date":"2023-06-19"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"rust_error_handling"},"buildId":"EEU_erGoU_JDwBtAMKr2I","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>