{"pageProps":{"postData":{"id":"07_salsa_dependency","contentHtml":"<p>通过一个简单的例子，发现我对 Salsa dependency 理解有误</p>\n<pre><code class=\"hljs language-rust\"><span class=\"hljs-meta\">#[salsa::input]</span>\n<span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">MyInput</span> {\n    field: <span class=\"hljs-type\">i32</span>\n}\n\n<span class=\"hljs-meta\">#[salsa::tracked]</span>\n<span class=\"hljs-keyword\">fn</span> <span class=\"hljs-title function_\">tracked_fn</span>(db: &#x26;<span class=\"hljs-keyword\">dyn</span> Db, input: MyInput) <span class=\"hljs-punctuation\">-></span> <span class=\"hljs-type\">i32</span> {\n    <span class=\"hljs-number\">0</span>\n}\n\n<span class=\"hljs-keyword\">fn</span> <span class=\"hljs-title function_\">main</span>() {\n    ...\n    <span class=\"hljs-keyword\">let</span> <span class=\"hljs-keyword\"></span><span class=\"hljs-variable\">input</span> = MyInput::<span class=\"hljs-title function_ invoke__\">new</span>(&#x26;<span class=\"hljs-keyword\">mut</span> db, <span class=\"hljs-number\">22</span>);\n    <span class=\"hljs-title function_ invoke__\">tracked_fn</span>(&#x26;db, input);\n    input.<span class=\"hljs-title function_ invoke__\">set_field</span>(&#x26;<span class=\"hljs-keyword\">mut</span> db, <span class=\"hljs-number\">44</span>);\n    <span class=\"hljs-title function_ invoke__\">tracked_fn</span>(&#x26;db, input);\n}\n</code></pre>\n<p>第二次调用 <code>tracked_fn(&#x26;db, input)</code> 能重用第一次的计算结果吗？</p>\n<p><code>tracked_fn(&#x26;db, input)</code> 需不需要重新计算，需要考虑 dependencies 有没有变化。这句话听着很简单，也很合理，但是我并没有真正理解它。重点不在 dependencies 是什么，而在是 “谁的” dependencies。</p>\n<p>回到具体问题，我之前一直认为是 <code>tracked_fn</code> 这个函数本身的 dependencies，那一个函数的 dependencies 就是它的参数以及函数体里调用的其他 tracked function。如果是这样，上述问题的答案就是不能重用，需要重新计算，因为参数发生了改变。</p>\n<p>但实际上，Salsa 并不需要重新计算，Salsa 认为的 dependencies 是针对 <code>tracked_fn(&#x26;db, input)</code> 这个计算结果。<code>input</code> 虽然作为参数输入，但在计算时并没有真正被用到，所以 <code>tracked_fn(&#x26;db, input)</code> 并不依赖 <code>input</code>，它的改变对结果不会有任何影响，所以不需要重新计算。</p>\n<p>再来看一个例子，对于 <code>input = MyInput::new(&#x26;mut db, 1)</code>，<code>tracked_fn(&#x26;db, input)</code> 依赖 <code>tracked_extra(db, input)</code> 吗？对于 <code>input = MyInput::new(&#x26;mut db, -1)</code> 呢？</p>\n<pre><code class=\"hljs language-rust\"><span class=\"hljs-meta\">#[salsa::tracked]</span>\n<span class=\"hljs-keyword\">fn</span> <span class=\"hljs-title function_\">tracked_fn</span>(db: &#x26;<span class=\"hljs-keyword\">dyn</span> Db, input MyInput) <span class=\"hljs-punctuation\">-></span> <span class=\"hljs-type\">i32</span> {\n    <span class=\"hljs-keyword\">if</span> input.<span class=\"hljs-title function_ invoke__\">field</span>(db) &#x3C; <span class=\"hljs-number\">0</span> {\n        <span class=\"hljs-title function_ invoke__\">tracked_extra</span>(db: &#x26;<span class=\"hljs-keyword\">dyn</span> Db, input)\n    } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-number\">0</span>\n    }\n}\n</code></pre>\n<hr>\n<p><strong>UPDATE(2022/9/7)</strong></p>\n<p>今天又有一点新的理解，值得一说</p>\n<pre><code class=\"hljs language-rust\"><span class=\"hljs-meta\">#[salsa::tracked]</span>\n<span class=\"hljs-keyword\">fn</span> <span class=\"hljs-title function_\">tracked_fn</span>(db: &#x26;<span class=\"hljs-keyword\">dyn</span> Db, input MyInput) <span class=\"hljs-punctuation\">-></span> <span class=\"hljs-type\">i32</span> {\n    <span class=\"hljs-title function_ invoke__\">tracked_extra</span>(db: &#x26;<span class=\"hljs-keyword\">dyn</span> Db, input)\n}\n</code></pre>\n<p>上述例子中 <code>tracked_fn(&#x26;db, input)</code> 依赖 <code>input</code> 吗？</p>\n<p>不依赖，只依赖 <code>tracked_extra(db: &#x26;dyn Db, input)</code></p>","title":"Salsa: dependency 理解纠正","date":"2022-09-02"}},"__N_SSG":true}