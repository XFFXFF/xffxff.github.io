{"pageProps":{"postData":{"id":"mdbook_multi_versions_deployment","contentHtml":"<h2>背景</h2>\n<p>新版 Salsa（Salsa 2022）还没有完成，仍然有很多用户在用旧版 Salsa，但是其文档已经被新版 Salsa 的文档替代了。为了让用户能够访问到旧版 Salsa 的文档，我们也需要部署旧版本的文档。</p>\n<p>对应的 PR：<a href=\"https://github.com/salsa-rs/salsa/pull/451\">https://github.com/salsa-rs/salsa/pull/451</a></p>\n<h2>方案一</h2>\n<p>我首先考虑的方案是在 Netlify 上部署两个项目，一个项目部署旧版 Salsa 的文档，另一个项目部署新版 Salsa 的文档。但是这样做有几个问题：</p>\n<ol>\n<li>两个项目的域名不一样，增加用户的记忆负担</li>\n<li>需要维护两个项目的部署</li>\n</ol>\n<h2>方案二</h2>\n<p>@nikomatsakis 建议让我们的 mdbook 支持多版本，而不是让旧版本重定向到一个外部链接。</p>\n<blockquote>\n<p>It'd be nice to modify the book here to just have both versions, I suppose, rather than redirecting to an external site. How hard would that be?</p>\n</blockquote>\n<p>最开始我想直接把旧版本的文档放到新版本的文档中，把它们合成一个新的 mdbook，文档的目录结构可能是这样的：</p>\n<pre><code>Salsa2022\n    - Overview\n    - Getting Started\n    - ...\nSalas\n    - Overview\n    - Getting Started\n    - ...\n</code></pre>\n<p>但是感觉这样比较麻烦，得手动把旧版本的文档复制到新版本的文档中，还得重新改造 <a href=\"https://github.com/salsa-rs/salsa/blob/2114c8ae0cb1ec23b56e31fbd3244d9f62e1f6c1/book/src/SUMMARY.md\">SUMMARY.md</a></p>\n<p>后来我考虑通过 URL 路径来区分不同版本的文档，比如：</p>\n<pre><code>Salsa2022: https://salsa-rs.netlify.app/ or https://salsa-rs.netlify.app/salsa2022\nSalsa: https://salsa-rs.netlify.app/salsa\n</code></pre>\n<p>经过一番探索，发现是可行的，只需要分别编译出不同版本的文档，然后将其放入不同的目录，并部署至 Netlify。</p>\n<pre><code>versions/\n    - salsa2022/\n    - salsa/\n</code></pre>\n<p>另外，还需要一个 <code>_redirects</code> 文件，用来重定向到默认的版本，即重定向 <code>/</code> 到 <code>/salsa2022</code>。</p>\n<pre><code># _redirects file\n/                /salsa2022\n</code></pre>\n<p>最终的目录结构是这样的：</p>\n<pre><code>versions/\n    - salsa2022/\n    - salsa/\n    - _redirects\n</code></pre>\n<p>编译不同版本的 mdbook 可以通过下面的脚本来实现：</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># 保存当前分支或提交哈希</span>\noriginal_branch=$(git rev-parse --abbrev-ref HEAD)\n<span class=\"hljs-keyword\">if</span> [ <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$original_branch</span>\"</span> == <span class=\"hljs-string\">\"HEAD\"</span> ]; <span class=\"hljs-keyword\">then</span>\n  original_branch=$(git rev-parse HEAD)\n<span class=\"hljs-keyword\">fi</span>\n\n<span class=\"hljs-built_in\">mkdir</span> -p versions  <span class=\"hljs-comment\"># 为所有版本创建根目录</span>\n\n<span class=\"hljs-comment\"># 声明关联数组来映射提交哈希到自定义版本目录名称</span>\n<span class=\"hljs-built_in\">declare</span> -A commit_to_version=( [<span class=\"hljs-string\">\"<span class=\"hljs-variable\">$original_branch</span>\"</span>]=<span class=\"hljs-string\">\"salsa2022\"</span> [<span class=\"hljs-string\">\"754eea8b5f8a31b1100ba313d59e41260b494225\"</span>]=<span class=\"hljs-string\">\"salsa\"</span> )\n\n<span class=\"hljs-comment\"># 遍历关联数组中的键（提交哈希或分支名称）</span>\n<span class=\"hljs-keyword\">for</span> commit <span class=\"hljs-keyword\">in</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">${!commit_to_version[@]}</span>\"</span>; <span class=\"hljs-keyword\">do</span>\n  git checkout <span class=\"hljs-variable\">$commit</span>\n  mdbook build\n  version_dir=<span class=\"hljs-string\">\"versions/<span class=\"hljs-variable\">${commit_to_version[$commit]}</span>\"</span>\n  <span class=\"hljs-built_in\">mkdir</span> -p <span class=\"hljs-variable\">$version_dir</span>\n  <span class=\"hljs-built_in\">mv</span> book/html/* <span class=\"hljs-variable\">$version_dir</span>\n  <span class=\"hljs-built_in\">rm</span> -rf book\n<span class=\"hljs-keyword\">done</span>\n\n<span class=\"hljs-comment\"># 返回到原始分支或提交</span>\ngit checkout <span class=\"hljs-variable\">$original_branch</span>\n\n<span class=\"hljs-comment\"># 将_redirects文件复制到根目录</span>\n<span class=\"hljs-built_in\">cp</span> _redirects versions\n\n</code></pre>\n<p>Netlify 的部署配置如下：</p>\n<p><img src=\"./netlify_build_settings.png\" alt=\"\"></p>","title":"部署多版本的 mdbook 到 Netlify","date":"2023-11-04"}},"__N_SSG":true}